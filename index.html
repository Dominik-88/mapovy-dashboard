<!DOCTYPE html>
<html lang="cs">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>JVS ‚Äì Interaktivn√≠ pl√°novac√≠ a provozn√≠ syst√©m</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
<script type="module">
    // Importy pro Firebase/Firestore
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, onSnapshot, collection, query, writeBatch, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    
    // Glob√°ln√≠ promƒõnn√© pro Firebase
    window.initializeApp = initializeApp;
    window.getAuth = getAuth;
    window.signInAnonymously = signInAnonymously;
    window.signInWithCustomToken = signInWithCustomToken;
    window.onAuthStateChanged = onAuthStateChanged;
    window.getFirestore = getFirestore;
    window.doc = doc;
    window.setDoc = setDoc;
    window.onSnapshot = onSnapshot;
    window.collection = collection;
    window.query = query;
    window.writeBatch = writeBatch;
    window.setLogLevel = setLogLevel;
</script>
<style>
/* --- 3. Barevn√© sch√©ma: Tmav√° se Zelenou (Default) / ƒåervenou (Alternativa) --- */
:root {
    --bg: #0b1220;
    --panel: #0f172a;
    --accent-primary: #16a34a; /* Zelen√° akcent (Good/Go) */
    --accent-secondary: #dc2626; /* ƒåerven√° akcent (Danger/Stop) */
    --text: #e5e7eb;
    --muted: #94a3b8;
    --completed: #34d399; /* Svƒõtle zelen√° pro dokonƒçen√© √∫koly */
}

/* Tmav√Ω m√≥d s ƒåerven√Ωm akcentem */
body.theme-red {
    --accent-primary: #dc2626;
    --accent-secondary: #16a34a;
    --completed: #f87171;
}

/* Z√°kladn√≠ styly */
*{box-sizing:border-box}
body{margin:0;font-family:'Inter',sans-serif;background:var(--bg);color:var(--text);transition:background-color 0.3s}
#map{height:100vh}

/* --- 2. Sada n√°stroj≈Ø na lev√© stranƒõ: Vylep≈°en√° Viditelnost --- */
.top{
    position:fixed;top:0;left:0;right:0;z-index:1000;
    background:linear-gradient(135deg, var(--panel), #080f1e);
    border-bottom:2px solid var(--accent-primary);
    color:#ecfdf5;padding:10px 14px;
    display:flex;justify-content:center;align-items:center;text-align:center;
    transition:border-color 0.3s;
}
.top h1{margin:0;font-size:20px;letter-spacing:2px}
.top span{display:block;font-size:12px;opacity:.8}

.tools-left{
    position:fixed;
    top:70px;
    left:10px;z-index:1000;
    background:var(--panel);border-radius:12px;
    box-shadow:0 10px 20px rgba(0,0,0,.5);
    padding:8px;width:56px; /* Zmen≈°en√° ≈°√≠≈ôka */
    display:flex;flex-direction:column;gap:8px; /* Men≈°√≠ mezery */
}
.tool-btn{
    background:#020617;
    border:1px solid var(--accent-primary);
    color:var(--accent-primary);
    border-radius:8px; /* Jemnƒõj≈°√≠ rohy */
    height:40px; /* Men≈°√≠ v√Ω≈°ka */
    cursor:pointer;font-size:16px; /* Men≈°√≠ font pro lep≈°√≠ centrov√°n√≠ */
    transition:background-color 0.2s, color 0.2s, border-color 0.2s, box-shadow 0.2s;
    display: flex;
    justify-content: center;
    align-items: center;
}
.tool-btn:hover{
    background-color:var(--accent-primary);
    color:var(--text);
    box-shadow:0 0 10px rgba(var(--accent-primary), 0.5);
}

/* --- 1. Kompaktn√≠ a zav√≠rac√≠ filtr panel --- */
.panel{
    position:fixed;
    top:70px;right:10px;z-index:1000;
    width:340px;
    max-height:calc(100vh - 90px);
    background:var(--panel);
    border-radius:14px;
    box-shadow:0 20px 40px rgba(0,0,0,.5);
    overflow:auto;padding:14px;
    transform:translateX(110%);
    transition:transform 0.3s ease-out;
}
.panel.open{
    transform:translateX(0);
}
.panel-close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: none;
    border: none;
    color: var(--muted);
    font-size: 20px;
    cursor: pointer;
    line-height: 1;
    transition: color 0.2s;
}
.panel-close-btn:hover {
    color: var(--accent-secondary);
}

.section{border-bottom:1px solid #1f2937;margin-bottom:14px;padding-bottom:14px}
.section:last-child{border:none;margin:0}
.section h2{margin:0 0 8px;font-size:13px;color:var(--accent-primary);transition:color 0.3s;}
label{font-size:11px;font-weight:700;color:var(--muted)}
input,select,button{width:100%;margin-top:4px;padding:8px;border-radius:8px;border:1px solid #1f2937;background:#020617;color:var(--text);font-size:12px;transition:border-color 0.2s}
input:focus, select:focus { border-color: var(--accent-primary); outline: none; }
button{cursor:pointer}
.primary{background:var(--accent-primary);border:none;font-weight:800;color:var(--text)}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.card{background:#020617;border:1px solid #1f2937;border-radius:12px;padding:10px;text-align:center}
.card .v{font-size:18px;font-weight:900;color:var(--accent-primary);transition:color 0.3s;}
.card .l{font-size:10px;color:var(--muted)}

/* STYL PRO DOKONƒåEN√â/NEDOKONƒåEN√â MARKERY */
.route-active{
    outline:3px solid var(--accent-primary);
    box-shadow:0 0 8px var(--accent-primary);
    transition:outline 0.3s, box-shadow 0.3s;
}
.completed-area {
    color: var(--completed) !important;
    fillColor: var(--completed) !important;
    outline: 3px solid var(--completed) !important;
    box-shadow: 0 0 8px var(--completed) !important;
}

/* Custom Modal for AI Output */
.ai-modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    z-index: 2000;
    display: flex;
    justify-content: center;
    align-items: center;
}
.ai-modal-content {
    background: var(--panel);
    border-radius: 16px;
    padding: 20px;
    width: 90%;
    max-width: 700px;
    max-height: 80vh;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.7);
    position: relative;
    color: var(--text);
    overflow-y: auto;
}
.ai-modal-body {
    white-space: pre-wrap;
    font-family: monospace;
    font-size: 13px;
    line-height: 1.5;
    background: #020617;
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #1f2937;
    overflow-x: auto;
}
/* Spinner */
.spinner {
    border: 4px solid rgba(255, 255, 255, 0.1);
    border-top: 4px solid var(--accent-primary);
    border-radius: 50%;
    width: 30px;
    height: 30px;
    animation: spin 1s linear infinite;
    margin: 20px auto;
}
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

/* --- Vylep≈°en√≠ pro Leaflet.Draw controls --- */
.leaflet-draw-toolbar a, .leaflet-draw-actions a {
    color: var(--text) !important;
    background: var(--panel) !important;
    border: 1px solid #1f2937 !important;
    border-radius: 4px !important;
    transition: background-color 0.2s, border-color 0.2s;
}
.leaflet-draw-toolbar a:hover, .leaflet-draw-actions a:hover {
    background: var(--accent-primary) !important;
    color: var(--text) !important;
    border-color: var(--accent-primary) !important;
}
</style>
</head>
<body id="appBody">
<div class="top">
    <div>
        <h1><i class="fas fa-map-marked-alt"></i> JVS - Pl√°novac√≠ a Provozn√≠ Syst√©m</h1>
        <span>Dominik Schmied | Verze 2.0 (Provozn√≠ Den√≠k)</span>
    </div>
</div>
<div id="map"></div>

<!-- Lev√° sada n√°stroj≈Ø -->
<div class="tools-left">
    <button class="tool-btn" onclick="togglePanel()" title="Otev≈ô√≠t/Zav≈ô√≠t Panel Filtr≈Ø"><i class="fas fa-filter"></i></button>
    <button class="tool-btn" onclick="startRoute()" title="Zaƒç√≠t Novou Trasovac√≠ Sekvenci"><i class="fas fa-route"></i></button>
    <button class="tool-btn" onclick="clearRoute()" title="Vyƒçistit Napl√°novanou Trasu a Markery"><i class="fas fa-trash-alt"></i></button>
    <button class="tool-btn" onclick="toggleHDMap()" title="P≈ôepnout Mapov√© Podklady (HD/OSM)"><i class="fas fa-satellite-dish"></i></button>
    <button class="tool-btn" onclick="toggleTheme()" title="Zmƒõnit Akcentn√≠ Barvu (Zelen√°/ƒåerven√°)"><i class="fas fa-palette"></i></button>
    <button class="tool-btn" onclick="geoLocate()" title="Naj√≠t Moj√≠ Polohu"><i class="fas fa-location-crosshairs"></i></button>
    <button class="tool-btn" id="draw-tool-btn" title="N√°stroje pro Kreslen√≠ a Mƒõ≈ôen√≠ Vzd√°lenosti"><i class="fas fa-pencil-ruler"></i></button>
    <button class="tool-btn" onclick="generateRoutePlan()" title="Generovat Pl√°n Inspekce pomoc√≠ AI"><i class="fas fa-magic"></i></button> 
</div>

<!-- Prav√Ω ovl√°dac√≠ panel (Filtr a Statistiky) -->
<div class="panel" id="filterPanel">
    <button class="panel-close-btn" onclick="togglePanel()"><i class="fas fa-times"></i></button>
    <div class="section">
        <h2>üîç Filtr Objekt≈Ø</h2>
        <label for="fName">N√°zev</label>
        <input id="fName" oninput="applyFilters()" placeholder="Zadejte n√°zev vodojemu/√öV">
        <label for="fOkres">Okres</label>
        <select id="fOkres" onchange="applyFilters()">
            <option value="all">V≈°echny</option>
        </select>
    </div>
    
    <!-- NOV√Å SEKCE: SOUHRN TRAVNAT√ùCH PLOCH -->
    <div class="section">
        <h2>üå≥ √ödr≈æba Travnat√Ωch Plocha</h2>
        <div id="grass-loading-status" class="text-center text-sm text-yellow-400">Naƒç√≠t√°n√≠ dat z datab√°ze...</div>
        <div class="grid" style="grid-template-columns: 1fr;">
            <div class="card"><div class="v" id="stGrassTotal">0 m¬≤</div><div class="l">Celkov√° plocha (m¬≤)</div></div>
            <div class="card"><div class="v" id="stGrassRemaining">0 m¬≤</div><div class="l">Zb√Ωv√° dokonƒçit (m¬≤)</div></div>
        </div>
    </div>
    
    <div class="section">
        <h2>üìä Statistiky a Trasa</h2>
        <div class="grid">
            <div class="card"><div class="v" id="stObj">0</div><div class="l">Objekt≈Ø (zobraz.)</div></div>
            <div class="card"><div class="v" id="stKm">0.0</div><div class="l">km v Trase</div></div>
        </div>
        <p class="text-xs mt-3 text-center text-gray-500">Kliknƒõte na bod na mapƒõ a zvolte "P≈ôidat do Trasy" nebo "Start Trasy".</p>
    </div>
</div>

<!-- Custom Modal pro zobrazen√≠ LLM v√Ωstupu -->
<div id="aiModal" class="ai-modal-overlay" style="display:none;">
    <div class="ai-modal-content">
        <button class="panel-close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
        <h2 id="aiModalTitle" class="text-xl font-bold mb-4"></h2>
        <div id="aiModalBody" class="ai-modal-body">
            <!-- Content and spinner go here -->
        </div>
        <div id="aiModalSources" class="text-xs text-muted mt-4 border-t border-gray-700 pt-2" style="display: none;">
            <!-- Sources go here if using search grounding -->
        </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script>
// --- GLOB√ÅLN√ç DATA A PROMƒöNN√â ---

let objects = [
    {n:"VDJ Amerika II",o:"PI",lat:49.305131,lon:14.166126},
    {n:"VDJ Drahonice",o:"ST",lat:49.202902,lon:14.063713},
    {n:"VDJ Vod≈àany",o:"ST",lat:49.16455,lon:14.177836},
    {n:"VDJ Hlavatce",o:"CB",lat:49.063584,lon:14.267751},
    {n:"VDJ ≈†ibeniƒçn√≠ vrch I",o:"PT",lat:49.025083,lon:13.994111},
    {n:"√öV Husinecka p≈ôehrada",o:"PT",lat:49.034362,lon:13.99683},
    {n:"VDJ ≈†ibeniƒçn√≠ vrch II",o:"PT",lat:49.02671,lon:13.994001},
    {n:"VDJ Z√°lu≈æany",o:"PI",lat:49.552857,lon:14.083381},
    {n:"VDJ Pt√°ƒçn√≠k",o:"PT",lat:49.066147,lon:14.186844},
    {n:"VDJ Zdoba",o:"CB",lat:49.212422,lon:14.338095},
    {n:"VDJ Domoradice",o:"CK",lat:48.829651,lon:14.326564},
    {n:"VDJ Horn√≠ Br√°na",o:"CK",lat:48.80797,lon:14.329352},
    {n:"VDJ Net≈ôebice",o:"CK",lat:48.783277,lon:14.456447},
    {n:"VDJ Ple≈°ivec",o:"CK",lat:48.802231,lon:14.304933},
    {n:"VDJ Doudleby",o:"CB",lat:48.888896,lon:14.480271},
    {n:"VDJ Jankov",o:"CB",lat:48.968747,lon:14.301697},
    {n:"VDJ Hos√≠n II",o:"CB",lat:49.030641,lon:14.501012},
    {n:"VDJ Chlum",o:"CB",lat:49.096493,lon:14.388679},
    {n:"VDJ Chot√Ωƒçany",o:"CB",lat:49.070748,lon:14.51946},
    {n:"VDJ Rudolfov III",o:"CB",lat:48.986207,lon:14.547076},
    {n:"VDJ Rimov - Vesce",o:"CB",lat:48.847847,lon:14.466957},
    {n:"VDJ Hosin",o:"CB",lat:49.033641,lon:14.492878},
    {n:"VDJ Vƒçeln√°",o:"CB",lat:48.924663,lon:14.463506},
    {n:"VDJ H√∫ry",o:"CB",lat:49.006417,lon:14.549815},
    {n:"VDJ Chlumec",o:"CB",lat:49.124766,lon:14.431321},
    {n:"VDJ Ole≈°n√≠k",o:"CB",lat:49.111103,lon:14.377766},
    {n:"ƒåS Bukovec",o:"CB",lat:48.881608,lon:14.449233},
    {n:"VDJ He≈ôman",o:"CB",lat:48.909479,lon:14.499876},
    {n:"ƒåS Vidov u ≈ôeky",o:"CB",lat:48.924157,lon:14.489619},
    {n:"Vrt Vidov",o:"CB",lat:48.924066,lon:14.489679},
    {n:"√öV Plav",o:"CB",lat:48.912611,lon:14.494018},
    {n:"VDJ ƒåekanice",o:"TA",lat:49.422197,lon:14.689896},
    {n:"VDJ Svat√° Anna",o:"TA",lat:49.401133,lon:14.69864},
    {n:"VDJ Bezdƒõƒç√≠n",o:"TA",lat:49.323096,lon:14.628405},
    {n:"VDJ Milevsko",o:"TA",lat:49.452521,lon:14.344102},
    {n:"VDJ Hodu≈°√≠n",o:"TA",lat:49.42967,lon:14.474214},
    {n:"VDJ V≈°echov",o:"TA",lat:49.430159,lon:14.623205},
    {n:"VDJ Zlukov",o:"TA",lat:49.196289,lon:14.736382},
    {n:"√öV T√°bor",o:"TA",lat:49.422872,lon:14.666426},
    {n:"ƒåS Sudomƒõ≈ôice",o:"TA",lat:49.28658,lon:14.547794},
    {n:"Provozn√≠ Vodojem T√°bor",o:"TA",lat:49.424264,lon:14.666384}
];

// Dynamick√© p≈ôid√°n√≠ travnat√Ωch ploch pro simulaci
objects.forEach(obj => {
    let base = obj.n.includes('VDJ') || obj.n.includes('√öV') ? 2500 : 800;
    obj.grass_m2 = base + Math.floor(Math.random() * 2000); // 800 a≈æ 4500 m¬≤
});


let filtered = [...objects];
let route = [];
let routeLine;
let markers = [];
let drawnItems;
let currentLocationMarker = null; // Pro sledov√°n√≠ markeru polohy

// Firestore promƒõnn√©
let db;
let auth;
let userId = 'anonymous'; // Default
let completionData = {}; // {objectName: {isCompleted: bool, grass_m2: number}}
let totalGrassArea = 0;
let remainingGrassArea = 0;

// --- MAPA A VRSTVY ---

const defaultTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 20,
    attribution: '&copy; OpenStreetMap contributors'
});

const esriTileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
    maxZoom: 19,
    attribution: 'Tiles &copy; Esri &mdash; Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
});

const map = L.map('map', { 
    preferCanvas: true,
    layers: [defaultTileLayer]
}).setView([49.1, 14.4], 9);

let currentTileLayer = defaultTileLayer;

// --- FIREBASE/FIRESTORE LOGIKA ---

async function initializeFirebase() {
    try {
        setLogLevel('debug');
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        if (!firebaseConfig.apiKey) {
            console.warn("Firebase config not found. Running without persistence.");
            document.getElementById('grass-loading-status').textContent = "Upozornƒõn√≠: Datab√°ze nen√≠ p≈ôipojena.";
            calculateAndDisplayGrassSummary(); // Spoƒç√≠tat jen ze statick√Ωch dat
            return;
        }

        const app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);

        // P≈ôihl√°≈°en√≠ u≈æivatele
        if (initialAuthToken) {
            await signInWithCustomToken(auth, initialAuthToken);
        } else {
            await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('grass-loading-status').textContent = `U≈æivatel: ${userId.substring(0, 8)}... (P≈ôipojeno)`;
                listenForCompletionUpdates(appId, userId);
            } else {
                console.error("Firebase Auth failed.");
                document.getElementById('grass-loading-status').textContent = "Chyba: P≈ôihl√°≈°en√≠ do datab√°ze selhalo.";
            }
        });

    } catch (e) {
        console.error("Chyba inicializace Firebase:", e);
        document.getElementById('grass-loading-status').textContent = "Chyba inicializace Firebase.";
    }
}

function listenForCompletionUpdates(appId, currentUserId) {
    const collPath = `/artifacts/${appId}/users/${currentUserId}/completionStatus`;
    const q = query(collection(db, collPath));
    
    // Zastavit star√Ω listener, pokud existuje (nen√≠ pot≈ôeba, proto≈æe se vol√° jen jednou po auth)

    onSnapshot(q, (snapshot) => {
        const changes = snapshot.docChanges();
        
        // Aktualizace completionData
        changes.forEach((change) => {
            if (change.type === "added" || change.type === "modified") {
                const data = change.doc.data();
                completionData[data.name] = {
                    isCompleted: data.isCompleted,
                    grass_m2: data.grass_m2 
                };
            } else if (change.type === "removed") {
                delete completionData[change.doc.id];
            }
        });

        // Mus√≠me zajistit, ≈æe v≈°echna statick√° data jsou v completionData,
        // a pokud ne, inicializovat je.
        initializeMissingCompletionData();
        
        // P≈ôepoƒç√≠tat a vykreslit data
        calculateAndDisplayGrassSummary();
        render(); // Vykresl√≠ markery s nov√Ωm stavem
    }, (error) => {
        console.error("Firestore snapshot chyba:", error);
        document.getElementById('grass-loading-status').textContent = "Chyba datab√°ze (smazan√° data).";
    });
}

function initializeMissingCompletionData() {
    const batch = writeBatch(db);
    let needsCommit = false;
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const collPath = `/artifacts/${appId}/users/${userId}/completionStatus`;

    objects.forEach(obj => {
        if (!completionData[obj.n]) {
            // Inicializuj chybƒõj√≠c√≠ data lok√°lnƒõ i v batchi
            completionData[obj.n] = { isCompleted: false, grass_m2: obj.grass_m2 };
            
            const docRef = doc(db, collPath, obj.n.replace(/ /g, '_')); // Pou≈æijeme n√°zev jako ID, ale nahrad√≠me mezery
            batch.set(docRef, { 
                name: obj.n,
                isCompleted: false,
                grass_m2: obj.grass_m2,
                // Pro jednodu≈°≈°√≠ dotazov√°n√≠
                okres: obj.o, 
            });
            needsCommit = true;
        }
    });

    if (needsCommit) {
        batch.commit().catch(e => console.error("Chyba p≈ôi inicializaci dat:", e));
    }
}


function calculateAndDisplayGrassSummary() {
    totalGrassArea = 0;
    remainingGrassArea = 0;

    // Proch√°z√≠me statick√Ω seznam objekt≈Ø, abychom zajistili, ≈æe pokryjeme v≈°e
    objects.forEach(obj => {
        const status = completionData[obj.n];
        const area = obj.grass_m2 || 0; 
        
        totalGrassArea += area;

        if (!status || status.isCompleted === false) {
            remainingGrassArea += area;
        }
    });

    // Aktualizace UI
    document.getElementById('stGrassTotal').textContent = totalGrassArea.toLocaleString('cs-CZ') + ' m¬≤';
    document.getElementById('stGrassRemaining').textContent = remainingGrassArea.toLocaleString('cs-CZ') + ' m¬≤';

    // Aktualizace barvy based on completion
    document.getElementById('stGrassRemaining').style.color = remainingGrassArea > 0 ? 'var(--accent-secondary)' : 'var(--completed)';
    document.getElementById('stGrassTotal').style.color = 'var(--accent-primary)';
}

window.toggleCompletionStatus = async function(name) {
    if (!db || !userId) {
        showModal("Chyba Datab√°ze", "Datab√°ze nen√≠ p≈ôipojena, nelze aktualizovat stav dokonƒçen√≠.");
        return;
    }
    
    const obj = objects.find(o => o.n === name);
    if (!obj) return;
    
    const currentStatus = completionData[name] ? completionData[name].isCompleted : false;
    const newStatus = !currentStatus;
    
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
    const docRef = doc(db, `/artifacts/${appId}/users/${userId}/completionStatus`, name.replace(/ /g, '_'));

    try {
        // Pouze setDoc, proto≈æe dokument ji≈æ byl inicializov√°n
        await setDoc(docRef, { 
            name: obj.n,
            isCompleted: newStatus,
            grass_m2: obj.grass_m2,
            okres: obj.o,
        }, { merge: true });
        
        // Zde se nemus√≠ znovu volat render/calculate, proto≈æe to za≈ô√≠d√≠ onSnapshot

    } catch (e) {
        showModal("Chyba Z√°pisu", `Nepoda≈ôilo se aktualizovat stav v datab√°zi: ${e.message}`);
        console.error("Firestore write error:", e);
    }
}


// --- MAPA A INTERAKCE ---

function toggleHDMap() {
    if (currentTileLayer === defaultTileLayer) {
        map.removeLayer(defaultTileLayer);
        map.addLayer(esriTileLayer);
        currentTileLayer = esriTileLayer;
    } else {
        map.removeLayer(esriTileLayer);
        map.addLayer(defaultTileLayer);
        currentTileLayer = defaultTileLayer;
    }
}

function toggleTheme() {
    const body = document.getElementById('appBody');
    const isRed = body.classList.toggle('theme-red');
    
    const topBar = document.querySelector('.top');
    const accentPrimary = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
    topBar.style.borderColor = accentPrimary;

    if (routeLine) {
        routeLine.setStyle({ color: accentPrimary });
    }
    
    render();
}

function removeCurrentLocationMarker() {
    if (currentLocationMarker) {
        map.removeLayer(currentLocationMarker);
        currentLocationMarker = null;
    }
}

function geoLocate() {
    removeCurrentLocationMarker(); // Odebr√°n√≠ p≈ôedchoz√≠ho markeru

    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            (position) => {
                const lat = position.coords.latitude;
                const lon = position.coords.longitude;
                map.setView([lat, lon], 14);
                
                const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-secondary');
                
                currentLocationMarker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'current-location-marker',
                        html: `<i class="fas fa-crosshairs fa-beat" style="color:${accentColor}; font-size: 24px;"></i>`,
                        iconSize: [24, 24],
                        iconAnchor: [12, 12]
                    })
                }).addTo(map).bindPopup('Aktu√°ln√≠ poloha').openPopup();
            },
            () => {
                console.error('Nepoda≈ôilo se zjistit Va≈°i polohu.');
            }
        );
    } else {
        console.warn('V√°≈° prohl√≠≈æeƒç nepodporuje geolokaci.');
    }
}


// --- TRASOV√ÅN√ç, FILTRY A VYKRESLOV√ÅN√ç ---

function getPopupContent(data) {
    const isInRoute = route.includes(data);
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
    
    const status = completionData[data.n] || { isCompleted: false, grass_m2: data.grass_m2 };
    const isCompleted = status.isCompleted;
    const completionColor = isCompleted ? 'var(--completed)' : accentColor;
    const completionText = isCompleted ? 'Odebrat Dokonƒçen√≠ (Dokonƒçeno)' : 'Oznaƒçit jako Dokonƒçen√©';
    const completionIcon = isCompleted ? 'fas fa-undo' : 'fas fa-check-double';
    
    return `
        <div style="color: #0b1220; font-family: sans-serif; min-width: 180px;">
            <h3 style="margin: 0 0 5px; color: ${accentColor};">${data.n}</h3>
            <p style="margin: 0 0 5px; font-size: 11px;">
                Okres: <strong>${data.o}</strong><br>
                Travnat√° plocha: <strong>${data.grass_m2.toLocaleString('cs-CZ')} m¬≤</strong>
            </p>
            
            <!-- Tlaƒç√≠tko pro Sledov√°n√≠ Dokonƒçen√≠ -->
            <button onclick="window.toggleCompletionStatus('${data.n}')" 
                    style="background: ${isCompleted ? completionColor : '#020617'}; 
                           color: ${isCompleted ? 'white' : completionColor}; 
                           border: 1px solid ${completionColor}; 
                           padding: 6px 10px; border-radius: 6px; cursor: pointer; margin-top: 5px; width: 100%; font-weight: bold;">
                <i class="${completionIcon}"></i> ${completionText}
            </button>
            
            <hr style="border-color: #ccc; margin: 8px 0;">
            
            <!-- Tlaƒç√≠tka pro Trasu -->
            ${isInRoute 
                ? `<button onclick="window.toggleRoutePoint('${data.n}')" style="background: ${accentColor}; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; margin-top: 5px; width: 100%; font-weight: bold;"><i class="fas fa-minus-circle"></i> Odebrat z Trasy</button>`
                : `<button onclick="window.toggleRoutePoint('${data.n}')" style="background: #0f172a; color: white; border: 1px solid ${accentColor}; padding: 5px 10px; border-radius: 6px; cursor: pointer; margin-top: 5px; width: 100%;"><i class="fas fa-plus-circle"></i> P≈ôidat do Trasy</button>`
            }
            <button onclick="window.startRouteFromPoint('${data.n}')" style="background: none; color: ${accentColor}; border: 1px solid ${accentColor}; padding: 5px 10px; border-radius: 6px; cursor: pointer; margin-top: 8px; width: 100%;"><i class="fas fa-play"></i> Zvolit jako Poƒç√°teƒçn√≠ Bod</button>
        </div>
    `;
}

function render() {
    markers.forEach(m => map.removeLayer(m));
    markers = [];
    
    const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
    const completedColor = getComputedStyle(document.documentElement).getPropertyValue('--completed');

    filtered.forEach(d => {
        const isCompleted = completionData[d.n] ? completionData[d.n].isCompleted : false;
        const markerColor = isCompleted ? completedColor : accentColor;
        
        const m = L.circleMarker([d.lat, d.lon], {
            radius: isCompleted ? 10 : 8,
            color: isCompleted ? completedColor : accentColor,
            fillColor: isCompleted ? completedColor : accentColor,
            fillOpacity: isCompleted ? 0.9 : 0.8,
            weight: 2
        }).addTo(map);

        m.data = d;
        m.bindPopup(() => getPopupContent(d));

        // Nastaven√≠ t≈ô√≠dy pro outline
        m.on('add', function() {
            const markerElement = m.getElement();
            if (markerElement) {
                if (isCompleted) {
                    markerElement.classList.add('completed-area');
                } else {
                    markerElement.classList.remove('completed-area');
                }
                
                // Aktualizace t≈ô√≠dy pro zv√Ωraznƒõn√≠ trasy
                if (route.includes(d)) {
                    markerElement.classList.add('route-active');
                } else {
                    markerElement.classList.remove('route-active');
                }
            }
        });

        const markerElement = m.getElement();
        if (markerElement) {
            // P≈ôi rychl√©m p≈ôepnut√≠/renderu, kdy u≈æ je element v DOM
             if (isCompleted) {
                markerElement.classList.add('completed-area');
            } else {
                markerElement.classList.remove('completed-area');
            }
            if (route.includes(d)) {
                markerElement.classList.add('route-active');
            } else {
                markerElement.classList.remove('route-active');
            }
        }
        
        markers.push(m);
    });
    
    document.getElementById('stObj').textContent = filtered.length;
    updateRouteLine();
}

window.toggleRoutePoint = function(name) {
    const data = objects.find(o => o.n === name);
    if (!data) return;
    
    const index = route.indexOf(data);

    if (index === -1) {
        route.push(data);
    } else {
        route.splice(index, 1);
    }

    render();
}

window.startRouteFromPoint = function(name) {
    const data = objects.find(o => o.n === name);
    if (!data) return;

    route = [data];
    map.closePopup();
    render();
}

function updateRouteLine() {
    if (routeLine) {
        map.removeLayer(routeLine);
    }

    let km = 0;
    if (route.length > 1) {
        const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
        const points = route.map(p => [p.lat, p.lon]);
        
        routeLine = L.polyline(points, {
            color: accentColor,
            weight: 5,
            opacity: 0.8,
            dashArray: '10, 5'
        }).addTo(map);

        for (let i = 1; i < route.length; i++) {
            km += map.distance([route[i-1].lat, route[i-1].lon], [route[i].lat, route[i].lon]);
        }
    }
    document.getElementById('stKm').textContent = (km / 1000).toFixed(1);
}

function clearRoute() {
    route = [];
    if (routeLine) {
        map.removeLayer(routeLine);
        routeLine = null;
    }
    removeCurrentLocationMarker(); // Odstranƒõn√≠ markeru polohy
    render();
}

function startRoute() {
    clearRoute();
}

function applyFilters() {
    const nameFilter = document.getElementById('fName').value.toLowerCase();
    const okresFilter = document.getElementById('fOkres').value;

    filtered = objects.filter(d => 
        (!nameFilter || d.n.toLowerCase().includes(nameFilter)) &&
        (okresFilter === 'all' || d.o === okresFilter)
    );
    render();
}

function togglePanel() {
    document.getElementById('filterPanel').classList.toggle('open');
}


// --- GEMINI API LOGIKA ---

const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
const apiKey = ""; 

function showModal(title, content, sources = []) {
    document.getElementById('aiModalTitle').textContent = title;
    document.getElementById('aiModalBody').innerHTML = content;
    
    const sourcesDiv = document.getElementById('aiModalSources');
    if (sources.length > 0) {
        sourcesDiv.style.display = 'block';
        sourcesDiv.innerHTML = '<strong>Zdroje pro Ovƒõ≈ôen√≠:</strong><br>' + sources.map(s => 
            `<a href="${s.uri}" target="_blank" class="text-xs text-blue-400 hover:text-blue-200 block">${s.title}</a>`
        ).join('');
    } else {
        sourcesDiv.style.display = 'none';
    }
    
    document.getElementById('aiModal').style.display = 'flex';
}

function closeModal() {
    document.getElementById('aiModal').style.display = 'none';
}

async function fetchWithBackoff(url, options, maxRetries = 5) {
    for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
            const response = await fetch(url, options);
            if (!response.ok) {
                if (response.status === 429 && attempt < maxRetries - 1) {
                    const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
                    await new Promise(resolve => setTimeout(resolve, delay));
                    continue; 
                }
                throw new Error(`API call failed with status: ${response.status}`);
            }
            return response;
        } catch (error) {
            if (attempt === maxRetries - 1) {
                throw error;
            }
            const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
            await new Promise(resolve => setTimeout(resolve, delay));
        }
    }
}

window.generateRoutePlan = async function() {
    if (route.length < 2) {
        showModal("Chyba Pl√°nu Trasy", `
            <p>Pro generov√°n√≠ protokolu inspekce mus√≠ trasa obsahovat minim√°lnƒõ dva objekty.<br>
            Aktu√°lnƒõ m√°te vybr√°no: <strong>${route.length}</strong> objekt≈Ø.</p>
        `);
        return;
    }

    showModal("Generov√°n√≠ Protokolu Inspekce...", '<div class="spinner"></div>');

    try {
        const km = parseFloat(document.getElementById('stKm').textContent);
        
        const routeList = route.map((d, i) => 
            `${i + 1}. ${d.n} (${d.o}) - Typ: ${d.n.includes('VDJ') ? 'Vodojem (VDJ)' : d.n.includes('√öV') ? '√öpravna Vody (√öV)' : d.n.includes('ƒåS') ? 'ƒåerpac√≠ Stanice (ƒåS)' : 'Ostatn√≠'}`
        ).join('\n');

        const systemPrompt = `Jsi profesion√°ln√≠ pl√°novaƒç √∫dr≈æby a ter√©nn√≠ch inspekc√≠ vodohospod√°≈ôsk√Ωch za≈ô√≠zen√≠ v ƒåesk√© republice. Tv√Ωm √∫kolem je na z√°kladƒõ seznamu nav≈°t√≠ven√Ωch bod≈Ø a celkov√© vzd√°lenosti vytvo≈ôit struƒçn√Ω, form√°tovan√Ω a akƒçn√≠ pl√°n inspekƒçn√≠ho protokolu pro technika. Protokol by mƒõl obsahovat tyto sekce:
1. **P≈ôehled Trasy:** Celkov√° vzd√°lenost, poƒçet bod≈Ø a celkov√Ω odhadovan√Ω ƒças trv√°n√≠ inspekce (ƒçist√Ω ƒças pr√°ce na m√≠stƒõ bez cesty). P≈ôedpokl√°dej 45-60 minut na √öV, 30-45 minut na VDJ, a 20-30 minut na ƒåS.
2. **Kl√≠ƒçov√© Priority:** Navrhni, kter√© za≈ô√≠zen√≠ vy≈æaduj√≠ detailnƒõj≈°√≠ kontrolu a proƒç (nap≈ô. √öV jako kritick√© body).
3. **Kontroln√≠ √ökony:** Vytvo≈ô kr√°tk√Ω kontroln√≠ seznam pro ka≈æd√Ω typ za≈ô√≠zen√≠ (VDJ, √öV, ƒåS) - maxim√°lnƒõ 3 nejd≈Øle≈æitƒõj≈°√≠ √∫kony pro ka≈æd√Ω typ (nap≈ô. kontrola oplocen√≠, mƒõ≈ôen√≠ pr≈Øtoku, vizu√°ln√≠ kontrola armatur, apod.).
4. **Doporuƒçen√≠ pro Optimalizaci:** Struƒçn√© doporuƒçen√≠ k p≈ô√≠padn√© optimalizaci trasy nebo zdroj≈Ø.
Odpov√≠dej pouze v ƒçe≈°tinƒõ. Pou≈æij Markdown pro form√°tov√°n√≠, jako jsou seznamy a tuƒçn√© p√≠smo.`;

        const userQuery = `Napl√°novan√° trasa zahrnuje ${route.length} objekt≈Ø s celkovou vzd√°lenost√≠ ${km.toFixed(1)} km. Body trasy v po≈ôad√≠:

${routeList}

Vygeneruj inspekƒçn√≠ protokol podle dan√Ωch pokyn≈Ø.`;


        const payload = {
            contents: [{ parts: [{ text: userQuery }] }],
            tools: [{ "google_search": {} }],
            systemInstruction: {
                parts: [{ text: systemPrompt }]
            },
        };

        const response = await fetchWithBackoff(`${API_URL}?key=${apiKey}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
        });

        const result = await response.json();
        
        const candidate = result.candidates?.[0];
        let generatedText = "Chyba: Nepoda≈ôilo se vygenerovat text. Zkuste to pros√≠m znovu.";
        let sources = [];

        if (candidate && candidate.content?.parts?.[0]?.text) {
            generatedText = candidate.content.parts[0].text;

            const groundingMetadata = candidate.groundingMetadata;
            if (groundingMetadata && groundingMetadata.groundingAttributions) {
                sources = groundingMetadata.groundingAttributions
                    .map(attribution => ({
                        uri: attribution.web?.uri,
                        title: attribution.web?.title,
                    }))
                    .filter(source => source.uri && source.title);
            }
        }
        
        showModal("‚ú® Protokol Inspekce - Generov√°no AI", generatedText, sources);

    } catch (error) {
        showModal("Chyba API", `
            <p>Nastala chyba p≈ôi komunikaci s AI slu≈æbou. Zkuste to pros√≠m znovu.<br>
            Detail chyby: ${error.message || 'Nezn√°m√° chyba'}</p>
        `);
    }
}


// --- LEAFLET.DRAW INTEGRACE ---
function initializeDrawControls() {
    drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const drawControl = new L.Control.Draw({
        edit: {
            featureGroup: drawnItems,
            poly: { allowIntersection: false }
        },
        draw: {
            polyline: {
                metric: true,
                shapeOptions: {
                    color: getComputedStyle(document.documentElement).getPropertyValue('--accent-secondary'),
                    weight: 3
                }
            },
            polygon: { showArea: true, allowIntersection: false },
            rectangle: { showArea: true },
            circle: true,
            marker: true,
            circlemarker: false
        }
    });

    drawControl.addTo(map);
    const drawToolbarContainer = document.querySelector('.leaflet-draw');
    if (drawToolbarContainer) {
        drawToolbarContainer.style.display = 'none';
    }

    document.getElementById('draw-tool-btn').addEventListener('click', () => {
        const drawToolbar = document.querySelector('.leaflet-draw-toolbar');
        if (drawToolbar) {
            const isVisible = drawToolbarContainer.style.display !== 'none';
            drawToolbarContainer.style.display = isVisible ? 'none' : 'block';
            
            if (!isVisible) {
                const buttonRect = document.getElementById('draw-tool-btn').getBoundingClientRect();
                drawToolbarContainer.style.position = 'fixed';
                drawToolbarContainer.style.top = `${buttonRect.top + buttonRect.height + 5}px`;
                drawToolbarContainer.style.left = '10px';
                drawToolbarContainer.style.zIndex = '1000';
            }
        }
    });

    map.on(L.Draw.Event.CREATED, function (e) {
        const type = e.layerType;
        const layer = e.layer;
        
        if (type === 'polyline') {
            const distance = L.GeometryUtil.length(layer);
            layer.bindPopup(`<strong>Vzd√°lenost:</strong> ${(distance / 1000).toFixed(2)} km`).openPopup();
        }
        if (type === 'polygon' || type === 'rectangle') {
             const area = L.GeometryUtil.geodesicArea(layer);
            layer.bindPopup(`<strong>Plocha:</strong> ${(area / 1000000).toFixed(2)} km¬≤`).openPopup();
        }

        drawnItems.addLayer(layer);
    });
}

// --- INICIALIZACE ---

[...new Set(objects.map(o => o.o))].forEach(o => {
    document.getElementById('fOkres').innerHTML += `<option value="${o}">${o}</option>`;
});

document.addEventListener('DOMContentLoaded', () => {
    initializeFirebase(); // Inicializace DB
    // render() je vol√°no po inicializaci datab√°ze v listenForCompletionUpdates
    initializeDrawControls();
});

window.closeModal = closeModal;

</script>
</body>
</html>
