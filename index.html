<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Vod√°rensk√© are√°ly - Management syst√©m</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; }

        #map { height: 100vh; width: 100%; }

        .top-bar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
            padding: 15px 20px;
            z-index: 1001;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .top-bar h1 { font-size: 20px; font-weight: 700; }

        .top-bar-actions { display: flex; gap: 10px; }

        .top-bar-btn {
            padding: 8px 16px;
            background: rgba(255,255,255,0.2);
            border: 1px solid rgba(255,255,255,0.3);
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.2s;
        }

        .top-bar-btn:hover { background: rgba(255,255,255,0.3); }

        .controls {
            position: absolute;
            top: 80px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            max-width: 340px;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .control-section { margin-bottom: 20px; padding-bottom: 20px; border-bottom: 1px solid #e2e8f0; }
        .control-section:last-child { border-bottom: none; margin-bottom: 0; }

        .section-title {
            font-size: 14px;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        label { display:block; font-weight:600; margin-bottom:6px; font-size:12px; color:#475569; }

        select, input, button { width:100%; padding:10px; border:1px solid #e2e8f0; border-radius:6px; font-size:13px; }

        input:focus, select:focus { outline:none; border-color:#3b82f6; box-shadow:0 0 0 3px rgba(59,130,246,0.1); }

        button { background:#3b82f6; color:white; font-weight:600; cursor:pointer; border:none; transition:all 0.2s; }
        button:hover { background:#2563eb; transform:translateY(-1px); box-shadow:0 4px 12px rgba(59,130,246,0.3); }
        button:active { transform:translateY(0); }

        .btn-secondary { background:#64748b; }
        .btn-secondary:hover { background:#475569; }

        .btn-success { background:#10b981; }
        .btn-success:hover { background:#059669; }

        .btn-danger { background:#ef4444; }
        .btn-danger:hover { background:#dc2626; }

        .stats-grid { display:grid; grid-template-columns:1fr 1fr; gap:10px; }

        .stat-card { background: linear-gradient(135deg,#f8fafc 0%,#f1f5f9 100%); padding:12px; border-radius:6px; border:1px solid #e2e8f0; }
        .stat-value { font-size:20px; font-weight:700; color:#1e293b; margin-bottom:4px; }
        .stat-label { font-size:11px; color:#64748b; text-transform:uppercase; letter-spacing:0.5px; }

        .route-planner { background:#fef3c7; padding:12px; border-radius:6px; border:1px solid #fbbf24; }
        .route-info { display:flex; justify-content:space-between; margin-top:10px; padding-top:10px; border-top:1px solid #fbbf24; }
        .route-metric { text-align:center; }
        .route-metric-value { font-size:18px; font-weight:700; color:#92400e; }
        .route-metric-label { font-size:10px; color:#92400e; margin-top:2px; }

        .selected-areals { margin-top:10px; }
        .areal-chip { display:inline-block; background:white; padding:6px 12px; border-radius:20px; margin:4px; font-size:11px; border:1px solid #fbbf24; color:#92400e; font-weight:600; }

        .leaflet-popup-content { margin:15px; min-width:250px; }
        .popup-title { font-size:18px; font-weight:700; margin-bottom:12px; color:#1e293b; border-bottom:2px solid #3b82f6; padding-bottom:8px; }
        .popup-detail { display:flex; justify-content:space-between; padding:8px 0; border-bottom:1px solid #e2e8f0; font-size:13px; }
        .popup-detail:last-of-type { border-bottom:none; }
        .popup-label { color:#64748b; font-weight:500; }
        .popup-value { font-weight:700; color:#1e293b; }

        .popup-actions { display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:12px; }
        .popup-btn { display:block; text-align:center; padding:10px; color:white; text-decoration:none; border-radius:6px; font-size:12px; font-weight:600; transition:all 0.2s; }
        .popup-btn-primary { background:#3b82f6; }
        .popup-btn-primary:hover { background:#2563eb; }
        .popup-btn-success { background:#10b981; }
        .popup-btn-success:hover { background:#059669; }

        .legend { background:white; padding:12px; border-radius:8px; box-shadow:0 4px 20px rgba(0,0,0,0.15); }
        .legend-title { font-weight:700; margin-bottom:10px; font-size:13px; color:#1e293b; }
        .legend-item { display:flex; align-items:center; margin-bottom:8px; font-size:12px; }
        .legend-color { width:24px; height:24px; border-radius:50%; margin-right:10px; border:3px solid white; box-shadow:0 2px 8px rgba(0,0,0,0.3); }

        .modal { display:none; position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.6); z-index:2000; align-items:center; justify-content:center; }
        .modal.active { display:flex; }
        .modal-content { background:white; border-radius:12px; padding:30px; max-width:600px; max-height:80vh; overflow-y:auto; box-shadow:0 20px 60px rgba(0,0,0,0.3); }
        .modal-header { font-size:24px; font-weight:700; margin-bottom:20px; color:#1e293b; }
        .modal-close { float:right; font-size:28px; cursor:pointer; color:#64748b; line-height:1; }
        .modal-close:hover { color:#1e293b; }

        .export-options { display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:20px; }
        .export-card { padding:20px; border:2px solid #e2e8f0; border-radius:8px; text-align:center; cursor:pointer; transition:all 0.2s; }
        .export-card:hover { border-color:#3b82f6; background:#f8fafc; transform:translateY(-2px); }
        .export-icon { font-size:36px; margin-bottom:10px; }
        .export-title { font-weight:700; margin-bottom:5px; color:#1e293b; }
        .export-desc { font-size:12px; color:#64748b; }

        .checkbox-group { display:flex; align-items:center; gap:8px; margin-bottom:10px; }
        .checkbox-group input[type="checkbox"] { width:auto; }

        @media (max-width:768px) {
            .top-bar { flex-direction:column; align-items:flex-start; gap:10px; }
            .top-bar h1 { font-size:16px; }
            .top-bar-actions { width:100%; justify-content:flex-start; flex-wrap:wrap; }
            .controls { max-width:calc(100vw - 20px); top:120px; }
            .stats-grid { grid-template-columns:1fr; }
        }

        /* small custom marker style fallback */
        .custom-marker { display:flex; align-items:center; justify-content:center; }
    </style>
</head>
<body>
    <div class="top-bar">
        <h1>üö∞ Vod√°rensk√© are√°ly - Management syst√©m</h1>
        <div class="top-bar-actions">
            <button class="top-bar-btn" onclick="openExportModal()">üì• Export</button>
            <button class="top-bar-btn" onclick="openHelpModal()">‚ùì N√°povƒõda</button>
        </div>
    </div>

    <div id="map"></div>

    <div class="controls">
        <div class="control-section">
            <div class="section-title"><span class="section-icon">üîç</span>Filtry a vyhled√°v√°n√≠</div>

            <div class="control-group">
                <label>Vyhledat are√°l</label>
                <input type="text" id="searchInput" placeholder="Zadejte n√°zev are√°lu..." oninput="searchAreal()">
            </div>

            <div class="control-group">
                <label>Filtr podle okresu</label>
                <select id="okresFilter" onchange="applyFilters()">
                    <option value="all">V≈°echny okresy (41)</option>
                    <option value="CB">ƒåesk√© Budƒõjovice (18)</option>
                    <option value="TA">T√°bor (11)</option>
                    <option value="CK">ƒåesk√Ω Krumlov (4)</option>
                    <option value="PT">Prachatice (3)</option>
                    <option value="PI">P√≠sek (2)</option>
                    <option value="ST">Strakonice (2)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Filtr podle kategorie</label>
                <select id="katFilter" onchange="applyFilters()">
                    <option value="all">V≈°echny kategorie (41)</option>
                    <option value="I.">Kategorie I - Vysok√° priorita (23)</option>
                    <option value="II.">Kategorie II - St≈ôedn√≠ priorita (15)</option>
                    <option value="">Bez kategorie (3)</option>
                </select>
            </div>

            <div class="control-group">
                <label>Minim√°ln√≠ v√Ωmƒõra (m¬≤)</label>
                <input type="number" id="minArea" placeholder="nap≈ô. 1000" oninput="applyFilters()">
            </div>
        </div>

        <div class="control-section">
            <div class="section-title"><span class="section-icon">üìä</span>Statistiky</div>
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="visibleCount">41</div>
                    <div class="stat-label">Are√°l≈Ø</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalArea">198k</div>
                    <div class="stat-label">m¬≤ celkem</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalFence">10.9k</div>
                    <div class="stat-label">bm oplocen√≠</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avgArea">4.8k</div>
                    <div class="stat-label">√ò v√Ωmƒõra</div>
                </div>
            </div>
        </div>

        <div class="control-section">
            <div class="section-title"><span class="section-icon">üó∫Ô∏è</span>Pl√°novaƒç tras</div>

            <div class="checkbox-group">
                <input type="checkbox" id="routeMode" onchange="toggleRouteMode()">
                <label style="margin: 0;">Aktivovat re≈æim v√Ωbƒõru tras</label>
            </div>

            <div id="routePlanner" style="display:none;">
                <div class="route-planner">
                    <div style="font-weight:600; margin-bottom:8px; color:#92400e;">Kliknƒõte na are√°ly pro vytvo≈ôen√≠ trasy</div>
                    <div class="selected-areals" id="selectedAreals"></div>
                    <div class="route-info">
                        <div class="route-metric">
                            <div class="route-metric-value" id="routeDistance">0</div>
                            <div class="route-metric-label">Kilometry</div>
                        </div>
                        <div class="route-metric">
                            <div class="route-metric-value" id="routeCost">0</div>
                            <div class="route-metric-label">Kƒç (palivo)</div>
                        </div>
                        <div class="route-metric">
                            <div class="route-metric-value" id="routeTime">0</div>
                            <div class="route-metric-label">Minut</div>
                        </div>
                    </div>
                    <button class="btn-success" style="margin-top:12px;" onclick="optimizeRoute()">üéØ Optimalizovat trasu</button>
                    <button class="btn-danger" style="margin-top:8px;" onclick="clearRoute()">üóëÔ∏è Vymazat trasu</button>
                </div>
            </div>
        </div>

        <div class="control-section">
            <div class="section-title"><span class="section-icon">‚öôÔ∏è</span>N√°stroje</div>
            <button onclick="resetView()">üîÑ Resetovat pohled</button>
            <button class="btn-secondary" style="margin-top:8px;" onclick="showAllAreals()">üëÅÔ∏è Zobrazit v≈°echny are√°ly</button>
            <button class="btn-success" style="margin-top:8px;" onclick="generateReport()">üìã Generovat report</button>
        </div>
    </div>

    <div id="exportModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('exportModal')">&times;</span>
            <div class="modal-header">Export dat</div>
            <div class="export-options">
                <div class="export-card" onclick="exportCSV()">
                    <div class="export-icon">üìÑ</div>
                    <div class="export-title">CSV</div>
                    <div class="export-desc">Pro Excel a Google Sheets</div>
                </div>
                <div class="export-card" onclick="exportGeoJSON()">
                    <div class="export-icon">üó∫Ô∏è</div>
                    <div class="export-title">GeoJSON</div>
                    <div class="export-desc">Pro GIS n√°stroje</div>
                </div>
                <div class="export-card" onclick="exportKML()">
                    <div class="export-icon">üåç</div>
                    <div class="export-title">KML</div>
                    <div class="export-desc">Pro Google Earth</div>
                </div>
                <div class="export-card" onclick="copyGoogleMapsLink()">
                    <div class="export-icon">üìç</div>
                    <div class="export-title">Google Maps</div>
                    <div class="export-desc">Sd√≠let odkaz</div>
                </div>
            </div>
        </div>
    </div>

    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeModal('helpModal')">&times;</span>
            <div class="modal-header">N√°povƒõda</div>
            <h3 style="margin-top:20px; color:#1e293b;">Z√°kladn√≠ ovl√°d√°n√≠</h3>
            <ul style="margin-left:20px; line-height:1.8; color:#475569;">
                <li><strong>Zoom:</strong> Koleƒçko my≈°i nebo pinch na mobilu</li>
                <li><strong>Pohyb:</strong> Ta≈æen√≠ my≈°√≠/prstem</li>
                <li><strong>Detail are√°lu:</strong> Kliknut√≠ na barevn√Ω bod</li>
                <li><strong>Navigace:</strong> Tlaƒç√≠tko v detailu are√°lu</li>
            </ul>

            <h3 style="margin-top:20px; color:#1e293b;">Pokroƒçil√© funkce</h3>
            <ul style="margin-left:20px; line-height:1.8; color:#475569;">
                <li><strong>Pl√°novaƒç tras:</strong> Aktivujte checkbox a klikejte na are√°ly pro v√Ωpoƒçet trasy</li>
                <li><strong>Optimalizace:</strong> Automaticky se≈ôad√≠ are√°ly pro nejkrat≈°√≠ trasu</li>
                <li><strong>Filtry:</strong> Kombinujte v√≠ce filtr≈Ø pro p≈ôesn√© v√Ωsledky</li>
                <li><strong>Export:</strong> Ulo≈æte data ve form√°tu CSV, GeoJSON nebo KML</li>
            </ul>

            <h3 style="margin-top:20px; color:#1e293b;">Barevn√© k√≥dov√°n√≠</h3>
            <ul style="margin-left:20px; line-height:1.8; color:#475569;">
                <li>üî¥ <strong>ƒåerven√°:</strong> Kategorie I (vysok√° priorita)</li>
                <li>üü† <strong>Oran≈æov√°:</strong> Kategorie II (st≈ôedn√≠ priorita)</li>
                <li>‚ö™ <strong>≈†ed√°:</strong> Bez kategorie</li>
            </ul>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        // ===== DATA (beze zmƒõn) =====
        const arealData = [
            { nazev: "VDJ Amerika II", okres: "PI", kategorie: "I.", oploceni: 293, vymera: 3303, lat: 49.305131, lon: 14.166126 },
            { nazev: "VDJ Drahonice", okres: "ST", kategorie: "I.", oploceni: 376, vymera: 5953, lat: 49.202902, lon: 14.063713 },
            { nazev: "VDJ Vod≈àany", okres: "ST", kategorie: "I.", oploceni: 252, vymera: 1594, lat: 49.147778, lon: 14.175278 },
            { nazev: "VDJ Hlavatce", okres: "CB", kategorie: "", oploceni: 424, vymera: 7968, lat: 49.063584, lon: 14.267751 },
            { nazev: "VDJ ≈†ibeniƒçn√≠ vrch I", okres: "PT", kategorie: "I.", oploceni: 245, vymera: 1835, lat: 49.013333, lon: 13.994444 },
            { nazev: "√öV Husinecka p≈ôehrada", okres: "PT", kategorie: "", oploceni: 703, vymera: 4908, lat: 49.058889, lon: 13.994722 },
            { nazev: "VDJ ≈†ibeniƒçn√≠ vrch II", okres: "PT", kategorie: "I.", oploceni: 340, vymera: 3206, lat: 49.026710, lon: 13.994001 },
            { nazev: "VDJ Z√°lu≈æany", okres: "PI", kategorie: "", oploceni: 299, vymera: 2350, lat: 49.316389, lon: 14.096111 },
            { nazev: "VDJ Pt√°ƒçn√≠k", okres: "PT", kategorie: "II.", oploceni: 239, vymera: 1070, lat: 49.091111, lon: 13.948056 },
            { nazev: "VDJ Zdoba", okres: "CB", kategorie: "II.", oploceni: 225, vymera: 15523, lat: 49.212422, lon: 14.338095 },
            { nazev: "VDJ Domoradice", okres: "CK", kategorie: "I.", oploceni: 450, vymera: 4148, lat: 48.812778, lon: 14.273056 },
            { nazev: "VDJ Horn√≠ Br√°na", okres: "CK", kategorie: "I.", oploceni: 187, vymera: 1665, lat: 48.807970, lon: 14.329352 },
            { nazev: "VDJ Net≈ôebice", okres: "CK", kategorie: "I.", oploceni: 136, vymera: 877, lat: 48.856389, lon: 14.318611 },
            { nazev: "VDJ Ple≈°ivec", okres: "CK", kategorie: "I.", oploceni: 119, vymera: 975, lat: 48.823056, lon: 14.165278 },
            { nazev: "VDJ Doudleby", okres: "CB", kategorie: "II.", oploceni: 79, vymera: 413, lat: 48.991944, lon: 14.505556 },
            { nazev: "VDJ Jankov", okres: "CB", kategorie: "I.", oploceni: 106, vymera: 784, lat: 49.033566, lon: 14.492817 },
            { nazev: "VDJ Hos√≠n II", okres: "CB", kategorie: "I.", oploceni: 399, vymera: 4173, lat: 49.016111, lon: 14.452778 },
            { nazev: "VDJ Chlum", okres: "CB", kategorie: "II.", oploceni: 63, vymera: 535, lat: 49.091944, lon: 14.534167 },
            { nazev: "VDJ Chot√Ωƒçany", okres: "CB", kategorie: "II.", oploceni: 338, vymera: 4775, lat: 49.133611, lon: 14.498889 },
            { nazev: "VDJ Rudolfov III", okres: "CB", kategorie: "I.", oploceni: 174, vymera: 1868, lat: 48.988889, lon: 14.595833 },
            { nazev: "VDJ Rimov - Vesce", okres: "CB", kategorie: "I.", oploceni: 99, vymera: 662, lat: 48.842778, lon: 14.525000 },
            { nazev: "VDJ Hosin", okres: "CB", kategorie: "II.", oploceni: 125, vymera: 809, lat: 49.013889, lon: 14.450278 },
            { nazev: "VDJ Vƒçeln√°", okres: "CB", kategorie: "II.", oploceni: 476, vymera: 8660, lat: 48.966389, lon: 14.454722 },
            { nazev: "VDJ H√∫ry", okres: "CB", kategorie: "I.", oploceni: 0, vymera: 395, lat: 49.058611, lon: 14.481944 },
            { nazev: "VDJ Chlumec", okres: "CB", kategorie: "II.", oploceni: 110, vymera: 811, lat: 49.054167, lon: 14.488889 },
            { nazev: "VDJ Ole≈°n√≠k", okres: "CB", kategorie: "I.", oploceni: 117, vymera: 380, lat: 49.056944, lon: 14.498611 },
            { nazev: "ƒåS Bukovec", okres: "CB", kategorie: "I.", oploceni: 300, vymera: 4943, lat: 48.949167, lon: 14.480833 },
            { nazev: "VDJ He≈ôman", okres: "CB", kategorie: "II.", oploceni: 119, vymera: 982, lat: 48.991667, lon: 14.535000 },
            { nazev: "ƒåS Vidov u ≈ôeky", okres: "CB", kategorie: "II.", oploceni: 212, vymera: 2501, lat: 48.950833, lon: 14.479722 },
            { nazev: "Vrt Vidov", okres: "CB", kategorie: "II.", oploceni: 164, vymera: 470, lat: 48.951111, lon: 14.480556 },
            { nazev: "√öV Plav", okres: "CB", kategorie: "I.", oploceni: 1413, vymera: 74777, lat: 49.006111, lon: 14.452778 },
            { nazev: "VDJ ƒåekanice", okres: "TA", kategorie: "I.", oploceni: 450, vymera: 6344, lat: 49.422197, lon: 14.689896 },
            { nazev: "VDJ Svat√° Anna", okres: "TA", kategorie: "I.", oploceni: 264, vymera: 4192, lat: 49.401133, lon: 14.698640 },
            { nazev: "VDJ Bezdƒõƒç√≠n", okres: "TA", kategorie: "I.", oploceni: 169, vymera: 1996, lat: 49.381667, lon: 14.700556 },
            { nazev: "VDJ Milevsko", okres: "TA", kategorie: "I.", oploceni: 129, vymera: 823, lat: 49.452521, lon: 14.344102 },
            { nazev: "VDJ Hodu≈°√≠n", okres: "TA", kategorie: "II.", oploceni: 205, vymera: 1708, lat: 49.429670, lon: 14.474214 },
            { nazev: "VDJ V≈°echov", okres: "TA", kategorie: "I.", oploceni: 199, vymera: 1574, lat: 49.430159, lon: 14.623205 },
            { nazev: "VDJ Zlukov", okres: "TA", kategorie: "II.", oploceni: 184, vymera: 1520, lat: 49.196289, lon: 14.736382 },
            { nazev: "√öV T√°bor", okres: "TA", kategorie: "II.", oploceni: 350, vymera: 12262, lat: 49.422872, lon: 14.666426 },
            { nazev: "ƒåS Sudomƒõ≈ôice", okres: "TA", kategorie: "I.", oploceni: 220, vymera: 2508, lat: 49.368611, lon: 14.720278 },
            { nazev: "Provozn√≠ Vodojem T√°bor", okres: "TA", kategorie: "II.", oploceni: 155, vymera: 1853, lat: 49.413889, lon: 14.659167 }
        ];

        // ===== MAPA =====
        const map = L.map('map').setView([49.15, 14.35], 10);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap',
            maxZoom: 19
        }).addTo(map);

        // ===== PROMƒöNN√â =====
        let markers = [];
        let selectedRoute = [];
        let routeMode = false;
        let routeLine = null;

        // ===== HELPERY =====
        const getMarkerColor = (kategorie) => {
            if (kategorie === 'I.') return '#dc2626';
            if (kategorie === 'II.') return '#f97316';
            return '#64748b';
        };

        const calculateDistance = (lat1, lon1, lat2, lon2) => {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };

        // ===== VYKRESLOV√ÅN√ç MARKER≈Æ =====
        const createMarkers = (data) => {
            // odeber star√©
            markers.forEach(m => map.removeLayer(m.marker));
            markers = [];

            data.forEach(areal => {
                const color = getMarkerColor(areal.kategorie);

                const icon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background-color: ${color}; width: 28px; height: 28px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [28, 28],
                    iconAnchor: [14, 14]
                });

                const marker = L.marker([areal.lat, areal.lon], { icon });

                const popupContent = `
                    <div class="popup-title">${areal.nazev}</div>
                    <div class="popup-detail"><span class="popup-label">Okres:</span><span class="popup-value">${areal.okres}</span></div>
                    <div class="popup-detail"><span class="popup-label">Kategorie:</span><span class="popup-value">${areal.kategorie || 'Bez kategorie'}</span></div>
                    <div class="popup-detail"><span class="popup-label">V√Ωmƒõra:</span><span class="popup-value">${areal.vymera.toLocaleString()} m¬≤</span></div>
                    <div class="popup-detail"><span class="popup-label">Oplocen√≠:</span><span class="popup-value">${areal.oploceni.toLocaleString()} bm</span></div>
                    <div class="popup-actions">
                        <a href="https://www.google.com/maps/dir/?api=1&destination=${areal.lat},${areal.lon}" target="_blank" class="popup-btn popup-btn-primary">üß≠ Navigovat</a>
                        <a href="#" onclick="addToRoute('${areal.nazev}'); return false;" class="popup-btn popup-btn-success">‚ûï Do trasy</a>
                    </div>
                `;

                marker.bindPopup(popupContent);

                marker.on('click', () => {
                    if (routeMode) addToRoute(areal.nazev);
                });

                marker.addTo(map);
                markers.push({ marker, data: areal });
            });

            updateStats(data);
        };

        // ===== STATISTIKY =====
        const updateStats = (data) => {
            document.getElementById('visibleCount').textContent = data.length;
            const totalArea = data.reduce((sum, a) => sum + a.vymera, 0);
            const totalFence = data.reduce((sum, a) => sum + a.oploceni, 0);
            const avgArea = data.length > 0 ? totalArea / data.length : 0;

            document.getElementById('totalArea').textContent = (totalArea / 1000).toFixed(1) + 'k';
            document.getElementById('totalFence').textContent = (totalFence / 1000).toFixed(1) + 'k';
            document.getElementById('avgArea').textContent = (avgArea / 1000).toFixed(1) + 'k';
        };

        // ===== FILTRY A VYHLED√ÅV√ÅN√ç =====
        const applyFilters = () => {
            const okresFilter = document.getElementById('okresFilter').value;
            const katFilter = document.getElementById('katFilter').value;
            const minArea = parseInt(document.getElementById('minArea').value) || 0;
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();

            let filtered = arealData.slice();

            if (okresFilter !== 'all') filtered = filtered.filter(a => a.okres === okresFilter);
            if (katFilter !== 'all') filtered = filtered.filter(a => a.kategorie === katFilter);
            if (minArea > 0) filtered = filtered.filter(a => a.vymera >= minArea);
            if (searchTerm) filtered = filtered.filter(a => a.nazev.toLowerCase().includes(searchTerm));

            createMarkers(filtered);
        };

        const searchAreal = () => { applyFilters(); };

        // ===== ZOBRAZOVAC√ç FUNKCE =====
        const resetView = () => { map.setView([49.15, 14.35], 10); };
        const showAllAreals = () => {
            document.getElementById('okresFilter').value = 'all';
            document.getElementById('katFilter').value = 'all';
            document.getElementById('minArea').value = '';
            document.getElementById('searchInput').value = '';
            applyFilters();
        };

        // ===== PL√ÅNOVAƒå TRAS =====
        const toggleRouteMode = () => {
            routeMode = document.getElementById('routeMode').checked;
            document.getElementById('routePlanner').style.display = routeMode ? 'block' : 'none';
            if (!routeMode) clearRoute();
        };

        const addToRoute = (arealName) => {
            if (!routeMode) return;
            const areal = arealData.find(a => a.nazev === arealName);
            if (!areal) return;
            if (selectedRoute.find(a => a.nazev === arealName)) return;
            selectedRoute.push(areal);
            updateRouteDisplay();
        };

        const updateRouteDisplay = () => {
            const container = document.getElementById('selectedAreals');
            container.innerHTML = selectedRoute.map(a => `<span class="areal-chip">${a.nazev}</span>`).join('');

            if (selectedRoute.length >= 2) {
                let totalDist = 0;
                for (let i = 0; i < selectedRoute.length - 1; i++) {
                    totalDist += calculateDistance(
                        selectedRoute[i].lat, selectedRoute[i].lon,
                        selectedRoute[i+1].lat, selectedRoute[i+1].lon
                    );
                }
                const fuelCost = totalDist * 0.08 * 38; // tv≈Øj vzorec (l/km * cena)
                const timeMinutes = Math.round(totalDist / 50 * 60);

                document.getElementById('routeDistance').textContent = totalDist.toFixed(1);
                document.getElementById('routeCost').textContent = Math.round(fuelCost);
                document.getElementById('routeTime').textContent = timeMinutes;

                drawRouteLine();
            } else {
                document.getElementById('routeDistance').textContent = '0';
                document.getElementById('routeCost').textContent = '0';
                document.getElementById('routeTime').textContent = '0';
                if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            }
        };

        const drawRouteLine = () => {
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            const coords = selectedRoute.map(a => [a.lat, a.lon]);
            routeLine = L.polyline(coords, { color: '#3b82f6', weight: 4, opacity: 0.7, dashArray: '10,10' }).addTo(map);
            map.fitBounds(routeLine.getBounds(), { padding: [50,50] });
        };

        const clearRoute = () => {
            selectedRoute = [];
            if (routeLine) { map.removeLayer(routeLine); routeLine = null; }
            document.getElementById('selectedAreals').innerHTML = '';
            document.getElementById('routeDistance').textContent = '0';
            document.getElementById('routeCost').textContent = '0';
            document.getElementById('routeTime').textContent = '0';
        };

        const optimizeRoute = () => {
            if (selectedRoute.length < 2) return;
            const start = selectedRoute[0];
            let unvisited = selectedRoute.slice(1);
            let optimized = [start];
            let current = start;
            while (unvisited.length > 0) {
                let nearest = null;
                let minDist = Infinity;
                unvisited.forEach(areal => {
                    const dist = calculateDistance(current.lat, current.lon, areal.lat, areal.lon);
                    if (dist < minDist) { minDist = dist; nearest = areal; }
                });
                optimized.push(nearest);
                current = nearest;
                unvisited = unvisited.filter(a => a !== nearest);
            }
            selectedRoute = optimized;
            updateRouteDisplay();
        };

        // ===== EXPORTY =====
        const exportCSV = () => {
            const headers = ['ID','Nazev','Okres','Kategorie','Vymera_m2','Oploceni_bm','GPS_Lat','GPS_Lon','Link_Mapy'];
            const rows = arealData.map(r => {
                const id = `${r.okres}_${r.nazev.replace(/\s+/g,'_')}`;
                const mapsLink = `https://www.google.com/maps?q=${r.lat},${r.lon}`;
                return [id, `"${r.nazev}"`, r.okres, r.kategorie || 'Bez kategorie', r.vymera, r.oploceni, r.lat.toFixed(6), r.lon.toFixed(6), mapsLink].join(';');
            });
            const csvContent = '\uFEFF' + [headers.join(';'), ...rows].join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = 'vodovody_export.csv';
            link.click();
            URL.revokeObjectURL(url);
            closeModal('exportModal');
        };

        const exportGeoJSON = () => {
            const features = arealData.map(r => ({
                type:'Feature',
                properties:{
                    id: `${r.okres}_${r.nazev.replace(/\s+/g,'_')}`,
                    nazev: r.nazev,
                    okres: r.okres,
                    kategorie: r.kategorie || 'Bez kategorie',
                    vymera: r.vymera,
                    oploceni: r.oploceni
                },
                geometry:{ type:'Point', coordinates:[r.lon, r.lat] }
            }));
            const geojson = { type:'FeatureCollection', features };
            const blob = new Blob([JSON.stringify(geojson, null, 2)], { type:'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = 'vodovody_export.geojson';
            link.click();
            URL.revokeObjectURL(url);
            closeModal('exportModal');
        };

        const exportKML = () => {
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
    <name>Vod√°rensk√© are√°ly</name>
`;
            arealData.forEach(a => {
                kml += `    <Placemark>
        <name>${a.nazev}</name>
        <description>Okres: ${a.okres}, Kategorie: ${a.kategorie || 'Bez'}, V√Ωmƒõra: ${a.vymera} m¬≤, Oplocen√≠: ${a.oploceni} bm</description>
        <Point><coordinates>${a.lon},${a.lat},0</coordinates></Point>
    </Placemark>
`;
            });
            kml += `</Document>
</kml>`;
            const blob = new Blob([kml], { type:'application/vnd.google-earth.kml+xml' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = 'vodovody_export.kml';
            link.click();
            URL.revokeObjectURL(url);
            closeModal('exportModal');
        };

        const copyGoogleMapsLink = () => {
            const center = map.getCenter();
            const zoom = map.getZoom();
            const url = `https://www.google.com/maps/@${center.lat},${center.lng},${zoom}z`;
            navigator.clipboard.writeText(url);
            alert('Odkaz zkop√≠rov√°n do schr√°nky!');
            closeModal('exportModal');
        };

        // ===== REPORT =====
        const generateReport = () => {
            const data = markers.map(m => m.data);
            const totalArea = data.reduce((s,a) => s + a.vymera, 0);
            const totalFence = data.reduce((s,a) => s + a.oploceni, 0);

            const report = `REPORT VOD√ÅRENSK√ùCH ARE√ÅL≈Æ
=====================================
Datum: ${new Date().toLocaleDateString('cs-CZ')}

CELKOV√ù P≈òEHLED
- Poƒçet are√°l≈Ø: ${data.length}
- Celkov√° v√Ωmƒõra: ${totalArea.toLocaleString()} m¬≤
- Celkov√° d√©lka oplocen√≠: ${totalFence.toLocaleString()} bm

KATEGORIE
- Kategorie I: ${data.filter(a => a.kategorie === 'I.').length} are√°l≈Ø
- Kategorie II: ${data.filter(a => a.kategorie === 'II.').length} are√°l≈Ø
- Bez kategorie: ${data.filter(a => !a.kategorie).length} are√°l≈Ø

OKRESY
- ƒåesk√© Budƒõjovice: ${data.filter(a => a.okres === 'CB').length} are√°l≈Ø
- T√°bor: ${data.filter(a => a.okres === 'TA').length} are√°l≈Ø
- ƒåesk√Ω Krumlov: ${data.filter(a => a.okres === 'CK').length} are√°l≈Ø
- Prachatice: ${data.filter(a => a.okres === 'PT').length} are√°l≈Ø
- P√≠sek: ${data.filter(a => a.okres === 'PI').length} are√°l≈Ø
- Strakonice: ${data.filter(a => a.okres === 'ST').length} are√°l≈Ø

TOP 5 NEJVƒöT≈†√çCH ARE√ÅL≈Æ
${data.sort((a,b) => b.vymera - a.vymera).slice(0,5).map((a,i) => `${i+1}. ${a.nazev} - ${a.vymera.toLocaleString()} m¬≤`).join('\n')}
`;
            const blob = new Blob([report], { type:'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url; link.download = 'vodovody_report.txt';
            link.click();
            URL.revokeObjectURL(url);
        };

        // ===== MODALY =====
        const openExportModal = () => document.getElementById('exportModal').classList.add('active');
        const openHelpModal = () => document.getElementById('helpModal').classList.add('active');
        const closeModal = (id) => document.getElementById(id).classList.remove('active');

        // ===== LEGENDA =====
        const legend = L.control({ position: 'bottomleft' });
        legend.onAdd = function() {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML = `
                <div class="legend-title">üé® Barevn√° legenda</div>
                <div class="legend-item"><div class="legend-color" style="background:#dc2626"></div><span>Kategorie I (vysok√° priorita)</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#f97316"></div><span>Kategorie II (st≈ôedn√≠ priorita)</span></div>
                <div class="legend-item"><div class="legend-color" style="background:#64748b"></div><span>Bez kategorie</span></div>
            `;
            return div;
        };
        legend.addTo(map);

        // ===== START - vykresli v≈°echny are√°ly =====
        createMarkers(arealData);
    </script>
</body>
</html>
