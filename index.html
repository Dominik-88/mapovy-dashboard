<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Mapový Dashboard – Vodárenské areály</title>

  <!-- Viewport -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <!-- Tailwind CSS (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- PWA placeholder -->
  <link rel="manifest" href="manifest.json" />

  <style>
    html, body {
      height: 100%;
      margin: 0;
    }
    #map {
      height: 100%;
      width: 100%;
    }
  </style>
</head>

<body class="h-full flex flex-col">

<!-- ===================== -->
<!-- HEADER -->
<!-- ===================== -->
<header class="bg-slate-800 text-white px-4 py-3 flex items-center justify-between">
  <div class="font-semibold text-sm sm:text-base">
    Mapový Dashboard – Vodárenské areály
  </div>
  <div id="statusBar" class="text-xs text-slate-300">
    Načítám data…
  </div>
</header>

<!-- ===================== -->
<!-- MAIN LAYOUT -->
<!-- ===================== -->
<div class="flex flex-1 overflow-hidden">

  <!-- SIDE PANEL -->
  <!-- SIDE PANEL -->
<aside class="hidden sm:flex w-80 bg-slate-100 border-r border-slate-200 flex-col">

  <!-- Filtry -->
  <div class="p-4 border-b">
    <div class="font-semibold mb-3">Filtry</div>

    <input id="filterText"
      type="text"
      placeholder="Název / okres"
      class="w-full mb-2 px-2 py-1 text-sm border rounded" />

    <select id="filterOkres"
      class="w-full mb-2 px-2 py-1 text-sm border rounded">
      <option value="">Všechny okresy</option>
    </select>

    <select id="filterKategorie"
      class="w-full mb-2 px-2 py-1 text-sm border rounded">
      <option value="">Všechny kategorie</option>
      <option value="I.">I.</option>
      <option value="II.">II.</option>
      <option value="">Bez</option>
    </select>

    <div class="flex gap-2">
      <input id="filterMinVymera"
        type="number"
        placeholder="Min m²"
        class="w-1/2 px-2 py-1 text-sm border rounded" />
      <input id="filterMaxVymera"
        type="number"
        placeholder="Max m²"
        class="w-1/2 px-2 py-1 text-sm border rounded" />
    </div>
  </div>

  <!-- Statistiky -->
  <div class="p-4 border-b">
    <div class="font-semibold mb-2">Statistiky</div>
    <div class="text-sm text-slate-700 space-y-1">
      <div>Počet: <span id="statCount">–</span></div>
      <div>Výměra: <span id="statVymera">–</span> m²</div>
      <div>Oplocení: <span id="statOploceni">–</span> m</div>
      <div>Průměr: <span id="statAvg">–</span> m²</div>
    </div>
  </div>

</aside>
<!-- Trasa -->
<div class="p-4 border-t">
  <div class="font-semibold mb-2">Trasa</div>

  <ul id="routeList" class="text-sm mb-2 space-y-1"></ul>

  <div class="text-sm text-slate-700 mb-2">
    Vzdálenost: <span id="routeKm">0</span> km<br>
    PHM: <span id="routeCost">0</span> Kč
  </div>

  <button id="routeClear"
    class="w-full bg-red-600 text-white text-sm py-1 rounded">
    Vyčistit trasu
  </button>
</div>


  <!-- MAP -->
  <main class="flex-1 relative">
    <div id="map"></div>
  </main>

</div>

<!-- ===================== -->
<!-- SCRIPTS -->
<!-- ===================== -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
/* =====================================================
   CONFIG
===================================================== */
const CONFIG = {
  STORAGE_KEY: 'arealy_v1',
  MAP_CENTER: [49.8, 15.5],
  MAP_ZOOM: 7
};

/* =====================================================
   STATUS BAR
===================================================== */
const StatusBar = {
  el: document.getElementById('statusBar'),

  set(text) {
    this.el.textContent = text;
  },

  setSaved() {
    this.set('Data uložena v LocalStorage');
  }
};

/* =====================================================
   STORE (LocalStorage)
===================================================== */
const Store = {
  load() {
    try {
      const raw = localStorage.getItem(CONFIG.STORAGE_KEY);
      return raw ? JSON.parse(raw) : [];
    } catch (e) {
      console.error('Chyba při načítání dat', e);
      return [];
    }
  },

  save(data) {
    localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(data));
    StatusBar.setSaved();
  }
};

/* =====================================================
   DATA MODEL
===================================================== */
function createAreal(data) {
  return {
    id: data.id || crypto.randomUUID(),
    nazev: data.nazev,
    okres: data.okres,
    typ: data.typ || '',
    kategorie: data.kategorie || '',
    vymera: Number(data.vymera) || 0,
    oploceni: Number(data.oploceni) || 0,
    lat: Number(data.lat),
    lon: Number(data.lon),
    pozn: data.pozn || '',
    created_at: data.created_at || new Date().toISOString(),
    updated_at: new Date().toISOString()
  };
}
<script>
/* =====================================================
   FILTERS
===================================================== */
const Filters = {
  state: {
    text: '',
    okres: '',
    kategorie: '',
    minVymera: null,
    maxVymera: null
  },

  init(data) {
    this.fillOkresy(data);

    document.getElementById('filterText')
      .addEventListener('input', e => {
        this.state.text = e.target.value.toLowerCase();
        App.refresh();
      });

    document.getElementById('filterOkres')
      .addEventListener('change', e => {
        this.state.okres = e.target.value;
        App.refresh();
      });

    document.getElementById('filterKategorie')
      .addEventListener('change', e => {
        this.state.kategorie = e.target.value;
        App.refresh();
      });

    document.getElementById('filterMinVymera')
      .addEventListener('input', e => {
        this.state.minVymera = e.target.value ? Number(e.target.value) : null;
        App.refresh();
      });

    document.getElementById('filterMaxVymera')
      .addEventListener('input', e => {
        this.state.maxVymera = e.target.value ? Number(e.target.value) : null;
        App.refresh();
      });
  },

  fillOkresy(data) {
    const select = document.getElementById('filterOkres');
    const okresy = [...new Set(data.map(a => a.okres))].sort();

    okresy.forEach(o => {
      const opt = document.createElement('option');
      opt.value = o;
      opt.textContent = o;
      select.appendChild(opt);
    });
  }
};

function applyFilters(data, f) {
  return data.filter(a =>
    (!f.text || a.nazev.toLowerCase().includes(f.text) || a.okres.toLowerCase().includes(f.text)) &&
    (!f.okres || a.okres === f.okres) &&
    (!f.kategorie || a.kategorie === f.kategorie) &&
    (!f.minVymera || a.vymera >= f.minVymera) &&
    (!f.maxVymera || a.vymera <= f.maxVymera)
  );
}
</script>
<script>
/* =====================================================
   STATS
===================================================== */
const Stats = {
  render(data) {
    const totalVymera = data.reduce((s,a)=>s+a.vymera,0);
    const totalOploceni = data.reduce((s,a)=>s+a.oploceni,0);

    document.getElementById('statCount').textContent = data.length;
    document.getElementById('statVymera').textContent = totalVymera;
    document.getElementById('statOploceni').textContent = totalOploceni;
    document.getElementById('statAvg').textContent =
      data.length ? Math.round(totalVymera / data.length) : 0;
  }
};
</script>
<script>
/* =====================================================
   ROUTE BUILDER
===================================================== */
const Route = {
  points: [],
  polyline: null,

  add(areal) {
    this.points.push(areal);
    this.render();
  },

  clear() {
    this.points = [];
    if (this.polyline) {
      MapApp.map.removeLayer(this.polyline);
      this.polyline = null;
    }
    this.render();
  },

  render() {
    const list = document.getElementById('routeList');
    list.innerHTML = '';

    this.points.forEach((a, i) => {
      const li = document.createElement('li');
      li.textContent = `${i+1}. ${a.nazev}`;
      list.appendChild(li);
    });

    this.drawLine();
    this.compute();
  },

  drawLine() {
    if (this.polyline) {
      MapApp.map.removeLayer(this.polyline);
    }

    if (this.points.length < 2) return;

    const latlngs = this.points.map(p => [p.lat, p.lon]);
    this.polyline = L.polyline(latlngs).addTo(MapApp.map);
  },

  compute() {
    let km = 0;

    for (let i = 1; i < this.points.length; i++) {
      km += haversine(
        this.points[i-1],
        this.points[i]
      );
    }

    km = Math.round(km * 10) / 10;

    document.getElementById('routeKm').textContent = km;
    document.getElementById('routeCost').textContent =
      Math.round(km * CONFIG.CENA_KM);
  }
};
</script>
  <script>
/* =====================================================
   MODAL
===================================================== */
const Modal = {
  el: document.getElementById('arealModal'),

  open(data = null) {
    this.el.classList.remove('hidden');
    this.el.classList.add('flex');

    if (data) {
      arealId.value = data.id;
      arealNazev.value = data.nazev;
      arealOkres.value = data.okres;
      arealKategorie.value = data.kategorie;
      arealVymera.value = data.vymera;
      arealOploceni.value = data.oploceni;
      arealLat.value = data.lat;
      arealLon.value = data.lon;
      arealPozn.value = data.pozn || '';
      arealDelete.classList.remove('hidden');
    } else {
      this.clear();
      arealDelete.classList.add('hidden');
    }
  },

  close() {
    this.el.classList.add('hidden');
    this.el.classList.remove('flex');
  },

  clear() {
    arealId.value = '';
    arealNazev.value = '';
    arealOkres.value = '';
    arealKategorie.value = '';
    arealVymera.value = '';
    arealOploceni.value = '';
    arealLat.value = '';
    arealLon.value = '';
    arealPozn.value = '';
  }
};
</script>

<script>
/* =====================================================
   HAVERSINE
===================================================== */
function haversine(a, b) {
  const R = 6371;
  const dLat = deg2rad(b.lat - a.lat);
  const dLon = deg2rad(b.lon - a.lon);

  const lat1 = deg2rad(a.lat);
  const lat2 = deg2rad(b.lat);

  const x =
    Math.sin(dLat / 2) * Math.sin(dLat / 2) +
    Math.sin(dLon / 2) * Math.sin(dLon / 2) *
    Math.cos(lat1) * Math.cos(lat2);

  const c = 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1 - x));
  return R * c;
}

function deg2rad(deg) {
  return deg * (Math.PI / 180);
}
</script>

popupContent(a) {
  return `
    <div class="text-sm">
      <div class="font-semibold">${a.nazev}</div>
      <div>Okres: ${a.okres}</div>
      <div>Výměra: ${a.vymera} m²</div>

      <div class="mt-2 flex gap-2">
        <button
          onclick='Route.add(${JSON.stringify(a)})'
          class="bg-blue-600 text-white px-2 py-1 text-xs rounded">
          Trasa
        </button>

        <button
          onclick='Modal.open(${JSON.stringify(a)})'
          class="bg-slate-600 text-white px-2 py-1 text-xs rounded">
          Upravit
        </button>
      </div>
    </div>
  `;
}


<script>
/* =====================================================
   APP CONTROLLER
===================================================== */
const App = {
  data: [],

  init() {
    MapApp.init();
    this.data = Store.load();

    if (this.data.length === 0) {
      this.data = [
        createAreal({
          nazev: 'VDJ Demo',
          okres: 'CB',
          kategorie: 'I.',
          vymera: 3300,
          oploceni: 290,
          lat: 49.305131,
          lon: 14.166126
        })
      ];
      Store.save(this.data);
    }

    Filters.init(this.data);
    this.refresh();
  },
this.map.on('click', e => {
  Modal.open({
    lat: e.latlng.lat.toFixed(6),
    lon: e.latlng.lng.toFixed(6)
  });
});

  refresh() {
    const filtered = applyFilters(this.data, Filters.state);
    MapApp.render(filtered);
    Stats.render(filtered);
  }
};
document.getElementById('routeClear')
  .addEventListener('click', () => Route.clear());

document.addEventListener('DOMContentLoaded', () => App.init());
</script>

<!-- MODAL AREAL -->
<div id="arealModal" class="fixed inset-0 bg-black/40 hidden items-center justify-center z-50">
  <div class="bg-white w-full max-w-md rounded shadow p-4">
    <div class="font-semibold mb-3">Areál</div>

    <input type="hidden" id="arealId" />

    <div class="space-y-2 text-sm">
      <input id="arealNazev" class="w-full border px-2 py-1 rounded" placeholder="Název" />
      <input id="arealOkres" class="w-full border px-2 py-1 rounded" placeholder="Okres" />
      <input id="arealKategorie" class="w-full border px-2 py-1 rounded" placeholder="Kategorie" />
      <input id="arealVymera" type="number" class="w-full border px-2 py-1 rounded" placeholder="Výměra m²" />
      <input id="arealOploceni" type="number" class="w-full border px-2 py-1 rounded" placeholder="Oplocení m" />
      <input id="arealLat" type="number" class="w-full border px-2 py-1 rounded" placeholder="Lat" />
      <input id="arealLon" type="number" class="w-full border px-2 py-1 rounded" placeholder="Lon" />
      <textarea id="arealPozn" class="w-full border px-2 py-1 rounded" placeholder="Poznámka"></textarea>
    </div>

    <div class="flex justify-between mt-4">
      <button id="arealDelete" class="text-red-600 text-sm">Smazat</button>
      <div class="flex gap-2">
        <button onclick="Modal.close()" class="px-3 py-1 text-sm">Zrušit</button>
        <button id="arealSave" class="bg-blue-600 text-white px-3 py-1 text-sm rounded">
          Uložit
        </button>
      </div>
    </div>
  </div>
</div>
<script>
/* =====================================================
   CRUD
===================================================== */
document.getElementById('arealSave').onclick = () => {
  const data = createAreal({
    id: arealId.value || undefined,
    nazev: arealNazev.value,
    okres: arealOkres.value,
    kategorie: arealKategorie.value,
    vymera: arealVymera.value,
    oploceni: arealOploceni.value,
    lat: arealLat.value,
    lon: arealLon.value,
    pozn: arealPozn.value
  });

  if (!data.nazev || !data.lat || !data.lon) {
    alert('Název a GPS jsou povinné');
    return;
  }

  const idx = App.data.findIndex(a => a.id === data.id);

  if (idx >= 0) {
    App.data[idx] = data;
  } else {
    App.data.push(data);
  }

  Store.save(App.data);
  Modal.close();
  App.refresh();
};

document.getElementById('arealDelete').onclick = () => {
  if (!confirm('Smazat areál?')) return;

  App.data = App.data.filter(a => a.id !== arealId.value);
  Store.save(App.data);
  Modal.close();
  App.refresh();
};
</script>

</body>
</html>




