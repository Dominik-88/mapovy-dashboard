<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JVS e-book</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />

    <style>
        :root {
            --accent-primary: #4ade80;
            --accent-secondary: #f87171;
            --bg-dark: #1a1a1a;
            --panel-bg: #2d2d2d;
        }
        body { margin: 0; padding: 0; font-family: sans-serif; background: var(--bg-dark); color: white; overflow: hidden; }
        
        /* HornÃ­ liÅ¡ta */
        .top { 
            height: 70px; 
            background: #111; 
            display: flex; 
            align-items: center; 
            padding: 0 20px; 
            border-bottom: 2px solid var(--accent-primary); 
        }
        .top h1 { margin: 0; font-size: 24px; color: var(--accent-primary); display: inline-block; vertical-align: middle; }
        
        /* Mapa */
        #map { height: calc(100vh - 70px); width: 100%; position: relative; }
        
        /* NÃ¡stroje vlevo */
        .tools-left { 
            position: absolute; 
            top: 90px; 
            left: 10px; 
            z-index: 1000; 
            display: flex; 
            flex-direction: column; 
            gap: 10px; 
        }
        .tool-btn { 
            background: var(--panel-bg); 
            border: 1px solid #444; 
            color: white; 
            padding: 12px; 
            border-radius: 8px; 
            cursor: pointer; 
            font-size: 18px;
            transition: 0.3s; 
        }
        .tool-btn:hover { background: #444; border-color: var(--accent-primary); }

        /* Panel vpravo */
        .panel { 
            position: absolute; 
            top: 90px; 
            right: 10px; 
            width: 320px; 
            background: var(--panel-bg); 
            z-index: 1000; 
            padding: 20px; 
            border-radius: 12px; 
            border: 1px solid #444; 
            max-height: 80vh; 
            overflow-y: auto; 
            display: none; 
        }
        .section { margin-bottom: 20px; border-bottom: 1px solid #444; padding-bottom: 15px; }
        .section h2 { font-size: 16px; margin-bottom: 10px; color: var(--accent-primary); }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .card { background: #1a1a1a; padding: 10px; border-radius: 8px; text-align: center; }
        .card .v { font-size: 18px; font-weight: bold; }
        .card .l { font-size: 10px; color: #aaa; text-transform: uppercase; margin-top: 5px; }
        
        input, select { width: 100%; background: #1a1a1a; border: 1px solid #444; color: white; padding: 8px; border-radius: 4px; margin-bottom: 10px; box-sizing: border-box; }
        .panel-close-btn { float: right; cursor: pointer; background: none; border: none; color: #888; font-size: 20px; }
        
        /* AI Modal */
        .ai-modal-overlay { 
            position: fixed; 
            top: 0; left: 0; 
            width: 100%; height: 100%; 
            background: rgba(0,0,0,0.85); 
            z-index: 2000; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
        }
        .ai-modal-content { 
            background: var(--panel-bg); 
            padding: 30px; 
            border-radius: 15px; 
            width: 90%; 
            max-width: 600px; 
            border: 1px solid var(--accent-primary); 
            position: relative;
        }
        .text-xs { font-size: 12px; }
        .mt-3 { margin-top: 12px; }
        .text-center { text-align: center; }
        .text-gray-500 { color: #6b7280; }
    </style>
</head>
<body id="appBody">

<div class="top">
    <div>
        <img src="https://drive.google.com/uc?export=view&id=1RjoeJUvpCYrXB-E70Kmm0hgpNZM7wEnD" alt="JVS Logo" style="height: 40px; margin-right: 10px; vertical-align: middle;">
        <h1>â€¢ JVS (e-book) â€¢</h1>
        <span style="font-size: 20px; font-weight: bold; margin-left: 10px;">â€¢ Dominik Schmied â€¢</span>
    </div>
</div>

<div id="map"></div>

<div class="tools-left">
    <button class="tool-btn" onclick="togglePanel()" title="OtevÅ™Ã­t/ZavÅ™Ã­t Panel FiltrÅ¯"><i class="fas fa-filter"></i></button>
    <button class="tool-btn" onclick="startRoute()" title="ZaÄÃ­t Novou TrasovacÃ­ Sekvenci"><i class="fas fa-route"></i></button>
    <button class="tool-btn" onclick="clearRoute()" title="VyÄistit NaplÃ¡novanou Trasu a Markery"><i class="fas fa-trash-alt"></i></button>
    <button class="tool-btn" onclick="toggleHDMap()" title="PÅ™epnout MapovÃ© Podklady (HD/OSM)"><i class="fas fa-satellite-dish"></i></button>
    <button class="tool-btn" onclick="toggleTheme()" title="ZmÄ›nit AkcentnÃ­ Barvu (ZelenÃ¡/ÄŒervenÃ¡)"><i class="fas fa-palette"></i></button>
    <button class="tool-btn" onclick="geoLocate()" title="NajÃ­t MojÃ­ Polohu"><i class="fas fa-location-crosshairs"></i></button>
    <button class="tool-btn" id="draw-tool-btn" title="NÃ¡stroje pro KreslenÃ­ a MÄ›Å™enÃ­ VzdÃ¡lenosti"><i class="fas fa-pencil-ruler"></i></button>
    <button class="tool-btn" onclick="generateRoutePlan()" title="Generovat PlÃ¡n Inspekce pomocÃ­ AI"><i class="fas fa-magic"></i></button> 
</div>

<div class="panel" id="filterPanel">
    <button class="panel-close-btn" onclick="togglePanel()"><i class="fas fa-times"></i></button>
    <div class="section">
        <h2>ğŸ” Filtr ObjektÅ¯</h2>
        <label for="fName">NÃ¡zev</label>
        <input id="fName" oninput="applyFilters()" placeholder="Zadejte nÃ¡zev vodojemu/ÃšV">
        <label for="fOkres">Okres</label>
        <select id="fOkres" onchange="applyFilters()">
            <option value="all">VÅ¡echny</option>
            <option value="PI">PI</option>
            <option value="ST">ST</option>
            <option value="CB">CB</option>
            <option value="PT">PT</option>
            <option value="CK">CK</option>
            <option value="TA">TA</option>
        </select>
    </div>
     
    <div class="section">
        <h2>ğŸŒ³ ÃšdrÅ¾ba TravnatÃ½ch Plocha</h2>
        <div id="grass-loading-status" class="text-center text-xs" style="color: #fbbf24; margin-bottom: 8px;">UpozornÄ›nÃ­: DatabÃ¡ze nenÃ­ pÅ™ipojena.</div>
        <div class="grid" style="grid-template-columns: 1fr;">
            <div class="card"><div class="v" id="stGrassTotal" style="color: var(--accent-primary);">498 093 mÂ²</div><div class="l">CelkovÃ¡ plocha (mÂ²)</div></div>
            <div class="card" style="margin-top:10px;"><div class="v" id="stGrassRemaining" style="color: var(--accent-secondary);">498 093 mÂ²</div><div class="l">ZbÃ½vÃ¡ dokonÄit (mÂ²)</div></div>
        </div>
    </div>
     
    <div class="section">
        <h2>ğŸ“Š Statistiky a Trasa</h2>
        <div class="grid">
            <div class="card"><div class="v" id="stObj">41</div><div class="l">ObjektÅ¯ (zobraz.)</div></div>
            <div class="card"><div class="v" id="stKm">0.0</div><div class="l">km v Trase</div></div>
        </div>
        <p class="text-xs mt-3 text-center text-gray-500">KliknÄ›te na bod na mapÄ› a zvolte "PÅ™idat do Trasy" nebo "Start Trasy".</p>
    </div>
     
    <div class="section">
        <h2>â˜ï¸ AktuÃ¡lnÃ­ poÄasÃ­ v regionech</h2>
        <ul class="text-xs" style="list-style: none; padding: 0; line-height: 1.6;">
            <li>ÄŒeskÃ© BudÄ›jovice: -1Â°C, pÅ™evÃ¡Å¾nÄ› zataÅ¾eno</li>
            <li>ÄŒeskÃ½ Krumlov: -2Â°C, ÄÃ¡steÄnÄ› sluneÄno</li>
            <li>JindÅ™ichÅ¯v Hradec: 13Â°C (max), dÃ©Å¡Å¥ konÄÃ­, zataÅ¾eno</li>
            <li>Prachatice: 7Â°C / 0Â°C, ÄÃ¡steÄnÄ› zataÅ¾eno</li>
            <li>TÃ¡bor: -2Â°C, pÅ™evÃ¡Å¾nÄ› zataÅ¾eno</li>
        </ul>
    </div>
</div>

<div id="aiModal" class="ai-modal-overlay" style="display:none;">
    <div class="ai-modal-content">
        <button class="panel-close-btn" onclick="closeModal()"><i class="fas fa-times"></i></button>
        <h2 id="aiModalTitle" class="text-xl font-bold mb-4">AI PlÃ¡novaÄ tras</h2>
        <div id="aiModalBody" class="ai-modal-body">
            ZpracovÃ¡vÃ¡m poÅ¾adavek pÅ™es AI...
        </div>
        <div id="aiModalSources" class="text-xs mt-4" style="display: none; border-top: 1px solid #444; pt-2;">
            </div>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet-routing-machine@latest/dist/leaflet-routing-machine.js"></script>

<script>
    // Inicializace mapy
    var map = L.map('map').setView([49.027, 14.470], 9);

    // PÅ™idÃ¡nÃ­ mapovÃ© vrstvy (OSM)
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Funkce pro otevÃ­rÃ¡nÃ­/zavÃ­rÃ¡nÃ­ panelu
    function togglePanel() {
        const panel = document.getElementById('filterPanel');
        panel.style.display = (panel.style.display === 'block') ? 'none' : 'block';
    }

    // AI Modal funkce
    function generateRoutePlan() {
        document.getElementById('aiModal').style.display = 'flex';
    }
    
    function closeModal() {
        document.getElementById('aiModal').style.display = 'none';
    }

    // PrÃ¡zdnÃ© funkce pro zachovÃ¡nÃ­ funkÄnosti tlaÄÃ­tek (zde doplnÃ­te logiku)
    function applyFilters() { console.log("FiltrovÃ¡nÃ­..."); }
    function startRoute() { console.log("Start trasy..."); }
    function clearRoute() { console.log("ÄŒiÅ¡tÄ›nÃ­..."); }
    function toggleHDMap() { console.log("ZmÄ›na mapy..."); }
    function toggleTheme() { console.log("ZmÄ›na barvy..."); }
    function geoLocate() { map.locate({setView: true, maxZoom: 15}); }

</script>
// --- GLOBÃLNÃ DATA A PROMÄšNNÃ‰ ---
Â 
let objects = [
Â Â Â Â {n:"VDJ Amerika II",o:"PI",lat:49.305131,lon:14.166126,grass_m2:3303},
Â Â Â Â {n:"VDJ Drahonice",o:"ST",lat:49.202902,lon:14.063713,grass_m2:5953},
Â Â Â Â {n:"VDJ VodÅˆany",o:"ST",lat:49.164550,lon:14.177836,grass_m2:1594},
Â Â Â Â {n:"VDJ Hlavatce",o:"CB",lat:49.063584,lon:14.267751,grass_m2:7968},
Â Â Â Â {n:"VDJ Å ibeniÄnÃ­ vrch I",o:"PT",lat:49.025083,lon:13.994111,grass_m2:1835},
Â Â Â Â {n:"ÃšV Husinecka pÅ™ehrada",o:"PT",lat:49.034362,lon:13.996830,grass_m2:4908},
Â Â Â Â {n:"VDJ Å ibeniÄnÃ­ vrch II",o:"PT",lat:49.026710,lon:13.994001,grass_m2:3206},
Â Â Â Â {n:"VDJ ZÃ¡luÅ¾any",o:"PI",lat:49.552857,lon:14.083381,grass_m2:2350},
Â Â Â Â {n:"VDJ PtÃ¡ÄnÃ­k",o:"PT",lat:49.066147,lon:14.186844,grass_m2:1070},
Â Â Â Â {n:"VDJ Zdoba",o:"CB",lat:49.212422,lon:14.338095,grass_m2:15523},
Â Â Â Â {n:"VDJ Domoradice",o:"CK",lat:48.829651,lon:14.326564,grass_m2:4148},
Â Â Â Â {n:"VDJ HornÃ­ BrÃ¡na",o:"CK",lat:48.807970,lon:14.329352,grass_m2:1665},
Â Â Â Â {n:"VDJ NetÅ™ebice",o:"CK",lat:48.783277,lon:14.456447,grass_m2:877},
Â Â Â Â {n:"VDJ PleÅ¡ivec",o:"CK",lat:48.802231,lon:14.304933,grass_m2:975},
Â Â Â Â {n:"VDJ Doudleby",o:"CB",lat:48.888896,lon:14.480271,grass_m2:413},
Â Â Â Â {n:"VDJ Jankov",o:"CB",lat:48.968747,lon:14.301697,grass_m2:784},
Â Â Â Â {n:"VDJ HosÃ­n II",o:"CB",lat:49.030641,lon:14.501012,grass_m2:4173},
Â Â Â Â {n:"VDJ Chlum",o:"CB",lat:49.096493,lon:14.388679,grass_m2:535},
Â Â Â Â {n:"VDJ ChotÃ½Äany",o:"CB",lat:49.070748,lon:14.519460,grass_m2:4775},
Â Â Â Â {n:"VDJ Rudolfov III",o:"CB",lat:48.986207,lon:14.547076,grass_m2:1868},
Â Â Â Â {n:"VDJ Rimov - Vesce",o:"CB",lat:48.847847,lon:14.466957,grass_m2:662},
Â Â Â Â {n:"VDJ Hosin",o:"CB",lat:49.033641,lon:14.492878,grass_m2:809},
Â Â Â Â {n:"VDJ VÄelnÃ¡",o:"CB",lat:48.924663,lon:14.463506,grass_m2:8660},
Â Â Â Â {n:"VDJ HÃºry",o:"CB",lat:49.006417,lon:14.549815,grass_m2:395},
Â Â Â Â {n:"VDJ Chlumec",o:"CB",lat:49.124766,lon:14.431321,grass_m2:811},
Â Â Â Â {n:"VDJ OleÅ¡nÃ­k",o:"CB",lat:49.111103,lon:14.377766,grass_m2:380},
Â Â Â Â {n:"ÄŒS Bukovec",o:"CB",lat:48.881608,lon:14.449233,grass_m2:4943},
Â Â Â Â {n:"VDJ HeÅ™man",o:"CB",lat:48.909479,lon:14.499876,grass_m2:982},
Â Â Â Â {n:"ÄŒS Vidov u Å™eky",o:"CB",lat:48.924157,lon:14.489619,grass_m2:2501},
Â Â Â Â {n:"Vrt Vidov",o:"CB",lat:48.924066,lon:14.489679,grass_m2:470},
Â Â Â Â {n:"ÃšV Plav",o:"CB",lat:48.912611,lon:14.494018,grass_m2:374777},
Â Â Â Â {n:"VDJ ÄŒekanice",o:"TA",lat:49.422197,lon:14.689896,grass_m2:6344},
Â Â Â Â {n:"VDJ SvatÃ¡ Anna",o:"TA",lat:49.401133,lon:14.698640,grass_m2:4192},
Â Â Â Â {n:"VDJ BezdÄ›ÄÃ­n",o:"TA",lat:49.323096,lon:14.628405,grass_m2:1996},
Â Â Â Â {n:"VDJ Milevsko",o:"TA",lat:49.452521,lon:14.344102,grass_m2:823},
Â Â Â Â {n:"VDJ HoduÅ¡Ã­n",o:"TA",lat:49.429670,lon:14.474214,grass_m2:1708},
Â Â Â Â {n:"VDJ VÅ¡echov",o:"TA",lat:49.430159,lon:14.623205,grass_m2:1574},
Â Â Â Â {n:"VDJ Zlukov",o:"TA",lat:49.196289,lon:14.736382,grass_m2:1520},
Â Â Â Â {n:"ÃšV TÃ¡bor",o:"TA",lat:49.422872,lon:14.666426,grass_m2:12262},
Â Â Â Â {n:"ÄŒS SudomÄ›Å™ice",o:"TA",lat:49.286580,lon:14.547794,grass_m2:2508},
Â Â Â Â {n:"ProvoznÃ­ Vodojem TÃ¡bor",o:"TA",lat:49.424264,lon:14.666384,grass_m2:1853}
];
Â 
let filtered = [...objects];
let route = [];
let routeLine;
let markers = [];
let drawnItems;
let currentLocationMarker = null; // Pro sledovÃ¡nÃ­ markeru polohy
let routingControl;
Â 
// Firestore promÄ›nnÃ©
let db;
let auth;
let userId = 'anonymous'; // Default
let completionData = {}; // {objectName: {isCompleted: bool, grass_m2: number}}
let totalGrassArea = 0;
let remainingGrassArea = 0;
Â 
// --- MAPA A VRSTVY ---
Â 
const defaultTileLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
Â Â Â Â maxZoom: 20,
Â Â Â Â attribution: 'Â© OpenStreetMap contributors'
});
Â 
const esriTileLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
Â Â Â Â maxZoom: 19,
Â Â Â Â attribution: 'Tiles Â© Esri â€” Source: Esri, i-cubed, USDA, USGS, AEX, GeoEye, Getmapping, Aerogrid, IGN, IGP, UPR-EGP, and the GIS User Community'
});
Â 
const map = L.map('map', { 
Â Â Â Â preferCanvas: true,
Â Â Â Â layers: [defaultTileLayer]
}).setView([49.1, 14.4], 9);
Â 
let currentTileLayer = defaultTileLayer;
Â 
// --- FIREBASE/FIRESTORE LOGIKA ---
Â 
async function initializeFirebase() {
Â Â Â Â try {
Â Â Â Â Â Â Â Â setLogLevel('debug');
Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
Â Â Â Â Â Â Â Â const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
Â Â Â Â Â Â Â Â const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
Â 
Â Â Â Â Â Â Â Â if (!firebaseConfig.apiKey) {
Â Â Â Â Â Â Â Â Â Â Â Â console.warn("Firebase config not found. Running without persistence.");
Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('grass-loading-status').textContent = "UpozornÄ›nÃ­: DatabÃ¡ze nenÃ­ pÅ™ipojena.";
Â Â Â Â Â Â Â Â Â Â Â Â calculateAndDisplayGrassSummary(); // SpoÄÃ­tat jen ze statickÃ½ch dat
Â Â Â Â Â Â Â Â Â Â Â Â return;
Â Â Â Â Â Â Â Â }
Â 
Â Â Â Â Â Â Â Â const app = initializeApp(firebaseConfig);
Â Â Â Â Â Â Â Â db = getFirestore(app);
Â Â Â Â Â Â Â Â auth = getAuth(app);
Â 
Â Â Â Â Â Â Â Â // PÅ™ihlÃ¡Å¡enÃ­ uÅ¾ivatele
Â Â Â Â Â Â Â Â if (initialAuthToken) {
Â Â Â Â Â Â Â Â Â Â Â Â await signInWithCustomToken(auth, initialAuthToken);
Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â await signInAnonymously(auth);
Â Â Â Â Â Â Â Â }
Â 
Â Â Â Â Â Â Â Â onAuthStateChanged(auth, (user) => {
Â Â Â Â Â Â Â Â Â Â Â Â if (user) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â userId = user.uid;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('grass-loading-status').textContent = `UÅ¾ivatel: ${userId.substring(0, 8)}... (PÅ™ipojeno)`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â listenForCompletionUpdates(appId, userId);
Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.error("Firebase Auth failed.");
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â document.getElementById('grass-loading-status').textContent = "Chyba: PÅ™ihlÃ¡Å¡enÃ­ do databÃ¡ze selhalo.";
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â });
Â 
Â Â Â Â } catch (e) {
Â Â Â Â Â Â Â Â console.error("Chyba inicializace Firebase:", e);
Â Â Â Â Â Â Â Â document.getElementById('grass-loading-status').textContent = "Chyba inicializace Firebase.";
Â Â Â Â }
}
Â 
function listenForCompletionUpdates(appId, currentUserId) {
Â Â Â Â const collPath = `/artifacts/${appId}/users/${currentUserId}/completionStatus`;
Â Â Â Â const q = query(collection(db, collPath));
Â Â Â Â Â 
Â Â Â Â // Zastavit starÃ½ listener, pokud existuje (nenÃ­ potÅ™eba, protoÅ¾e se volÃ¡ jen jednou po auth)
Â 
Â Â Â Â onSnapshot(q, (snapshot) => {
Â Â Â Â Â Â Â Â const changes = snapshot.docChanges();
Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â // Aktualizace completionData
Â Â Â Â Â Â Â Â changes.forEach((change) => {
Â Â Â Â Â Â Â Â Â Â Â Â if (change.type === "added" || change.type === "modified") {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const data = change.doc.data();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â completionData[data.name] = {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isCompleted: data.isCompleted,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â grass_m2: data.grass_m2 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â };
Â Â Â Â Â Â Â Â Â Â Â Â } else if (change.type === "removed") {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â delete completionData[change.doc.id];
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â });
Â 
Â Â Â Â Â Â Â Â // MusÃ­me zajistit, Å¾e vÅ¡echna statickÃ¡ data jsou v completionData,
Â Â Â Â Â Â Â Â // a pokud ne, inicializovat je.
Â Â Â Â Â Â Â Â initializeMissingCompletionData();
Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â // PÅ™epoÄÃ­tat a vykreslit data
Â Â Â Â Â Â Â Â calculateAndDisplayGrassSummary();
Â Â Â Â Â Â Â Â render(); // VykreslÃ­ markery s novÃ½m stavem
Â Â Â Â }, (error) => {
Â Â Â Â Â Â Â Â console.error("Firestore snapshot chyba:", error);
Â Â Â Â Â Â Â Â document.getElementById('grass-loading-status').textContent = "Chyba databÃ¡ze (smazanÃ¡ data).";
Â Â Â Â });
}
Â 
function initializeMissingCompletionData() {
Â Â Â Â const batch = writeBatch(db);
Â Â Â Â let needsCommit = false;
Â Â Â Â const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
Â Â Â Â const collPath = `/artifacts/${appId}/users/${userId}/completionStatus`;
Â 
Â Â Â Â objects.forEach(obj => {
Â Â Â Â Â Â Â Â if (!completionData[obj.n]) {
Â Â Â Â Â Â Â Â Â Â Â Â // Inicializuj chybÄ›jÃ­cÃ­ data lokÃ¡lnÄ› i v batchi
Â Â Â Â Â Â Â Â Â Â Â Â completionData[obj.n] = { isCompleted: false, grass_m2: obj.grass_m2 };
Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â const docRef = doc(db, collPath, obj.n.replace(/ /g, '_')); // PouÅ¾ijeme nÃ¡zev jako ID, ale nahradÃ­me mezery
Â Â Â Â Â Â Â Â Â Â Â Â batch.set(docRef, { 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â name: obj.n,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â isCompleted: false,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â grass_m2: obj.grass_m2,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Pro jednoduÅ¡Å¡Ã­ dotazovÃ¡nÃ­
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â okres: obj.o, 
Â Â Â Â Â Â Â Â Â Â Â Â });
Â Â Â Â Â Â Â Â Â Â Â Â needsCommit = true;
Â Â Â Â Â Â Â Â }
Â Â Â Â });
Â 
Â Â Â Â if (needsCommit) {
Â Â Â Â Â Â Â Â batch.commit().catch(e => console.error("Chyba pÅ™i inicializaci dat:", e));
Â Â Â Â }
}
Â 
Â 
function calculateAndDisplayGrassSummary() {
Â Â Â Â totalGrassArea = 0;
Â Â Â Â remainingGrassArea = 0;
Â 
Â Â Â Â // ProchÃ¡zÃ­me statickÃ½ seznam objektÅ¯, abychom zajistili, Å¾e pokryjeme vÅ¡e
Â Â Â Â objects.forEach(obj => {
Â Â Â Â Â Â Â Â const status = completionData[obj.n];
Â Â Â Â Â Â Â Â const area = obj.grass_m2 || 0; 
Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â totalGrassArea += area;
Â 
Â Â Â Â Â Â Â Â if (!status || status.isCompleted === false) {
Â Â Â Â Â Â Â Â Â Â Â Â remainingGrassArea += area;
Â Â Â Â Â Â Â Â }
Â Â Â Â });
Â 
Â Â Â Â // Aktualizace UI
Â Â Â Â document.getElementById('stGrassTotal').textContent = totalGrassArea.toLocaleString('cs-CZ') + ' mÂ²';
Â Â Â Â document.getElementById('stGrassRemaining').textContent = remainingGrassArea.toLocaleString('cs-CZ') + ' mÂ²';
Â 
Â Â Â Â // Aktualizace barvy based on completion
Â Â Â Â document.getElementById('stGrassRemaining').style.color = remainingGrassArea > 0 ? 'var(--accent-secondary)' : 'var(--completed)';
Â Â Â Â document.getElementById('stGrassTotal').style.color = 'var(--accent-primary)';
}
Â 
window.toggleCompletionStatus = async function(name) {
Â Â Â Â if (!db || !userId) {
Â Â Â Â Â Â Â Â showModal("Chyba DatabÃ¡ze", "DatabÃ¡ze nenÃ­ pÅ™ipojena, nelze aktualizovat stav dokonÄenÃ­.");
Â Â Â Â Â Â Â Â return;
Â Â Â Â }
Â Â Â Â Â 
Â Â Â Â const obj = objects.find(o => o.n === name);
Â Â Â Â if (!obj) return;
Â Â Â Â Â 
Â Â Â Â const currentStatus = completionData[name] ? completionData[name].isCompleted : false;
Â Â Â Â const newStatus = !currentStatus;
Â Â Â Â Â 
Â Â Â Â const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
Â Â Â Â const docRef = doc(db, `/artifacts/${appId}/users/${userId}/completionStatus`, name.replace(/ /g, '_'));
Â 
Â Â Â Â try {
Â Â Â Â Â Â Â Â // Pouze setDoc, protoÅ¾e dokument jiÅ¾ byl inicializovÃ¡n
Â Â Â Â Â Â Â Â await setDoc(docRef, { 
Â Â Â Â Â Â Â Â Â Â Â Â name: obj.n,
Â Â Â Â Â Â Â Â Â Â Â Â isCompleted: newStatus,
Â Â Â Â Â Â Â Â Â Â Â Â grass_m2: obj.grass_m2,
Â Â Â Â Â Â Â Â Â Â Â Â okres: obj.o,
Â Â Â Â Â Â Â Â }, { merge: true });
Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â // Zde se nemusÃ­ znovu volat render/calculate, protoÅ¾e to zaÅ™Ã­dÃ­ onSnapshot
Â 
Â Â Â Â } catch (e) {
Â Â Â Â Â Â Â Â showModal("Chyba ZÃ¡pisu", `NepodaÅ™ilo se aktualizovat stav v databÃ¡zi: ${e.message}`);
Â Â Â Â Â Â Â Â console.error("Firestore write error:", e);
Â Â Â Â }
}
Â 
Â 
// --- MAPA A INTERAKCE ---
Â 
function toggleHDMap() {
Â Â Â Â if (currentTileLayer === defaultTileLayer) {
Â Â Â Â Â Â Â Â map.removeLayer(defaultTileLayer);
Â Â Â Â Â Â Â Â map.addLayer(esriTileLayer);
Â Â Â Â Â Â Â Â currentTileLayer = esriTileLayer;
Â Â Â Â } else {
Â Â Â Â Â Â Â Â map.removeLayer(esriTileLayer);
Â Â Â Â Â Â Â Â map.addLayer(defaultTileLayer);
Â Â Â Â Â Â Â Â currentTileLayer = defaultTileLayer;
Â Â Â Â }
}
Â 
function toggleTheme() {
Â Â Â Â const body = document.getElementById('appBody');
Â Â Â Â const isRed = body.classList.toggle('theme-red');
Â Â Â Â Â 
Â Â Â Â const topBar = document.querySelector('.top');
Â Â Â Â const accentPrimary = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
Â Â Â Â topBar.style.borderColor = accentPrimary;
Â 
Â Â Â Â if (routeLine) {
Â Â Â Â Â Â Â Â routeLine.setStyle({ color: accentPrimary });
Â Â Â Â }
Â Â Â Â Â 
Â Â Â Â render();
}
Â 
function removeCurrentLocationMarker() {
Â Â Â Â if (currentLocationMarker) {
Â Â Â Â Â Â Â Â map.removeLayer(currentLocationMarker);
Â Â Â Â Â Â Â Â currentLocationMarker = null;
Â Â Â Â }
}
Â 
function geoLocate() {
Â Â Â Â removeCurrentLocationMarker(); // OdebrÃ¡nÃ­ pÅ™edchozÃ­ho markeru
Â 
Â Â Â Â if (navigator.geolocation) {
Â Â Â Â Â Â Â Â navigator.geolocation.getCurrentPosition(
Â Â Â Â Â Â Â Â Â Â Â Â (position) => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const lat = position.coords.latitude;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const lon = position.coords.longitude;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â map.setView([lat, lon], 14);
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-secondary');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â currentLocationMarker = L.marker([lat, lon], {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â icon: L.divIcon({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â className: 'current-location-marker',
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â html: `<i class="fas fa-crosshairs fa-beat" style="color:${accentColor}; font-size: 24px;"></i>`,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â iconSize: [24, 24],
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â iconAnchor: [12, 12]
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â })
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }).addTo(map).bindPopup('AktuÃ¡lnÃ­ poloha').openPopup();
Â Â Â Â Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â Â Â Â Â () => {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â console.error('NepodaÅ™ilo se zjistit VaÅ¡i polohu.');
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â );
Â Â Â Â } else {
Â Â Â Â Â Â Â Â console.warn('VÃ¡Å¡ prohlÃ­Å¾eÄ nepodporuje geolokaci.');
Â Â Â Â }
}
Â 
Â 
// --- TRASOVÃNÃ, FILTRY A VYKRESLOVÃNÃ ---
Â 
function getPopupContent(data) {
Â Â Â Â const isInRoute = route.includes(data);
Â Â Â Â const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
Â Â Â Â Â 
Â Â Â Â const status = completionData[data.n] || { isCompleted: false, grass_m2: data.grass_m2 };
Â Â Â Â const isCompleted = status.isCompleted;
Â Â Â Â const completionColor = isCompleted ? 'var(--completed)' : accentColor;
Â Â Â Â const completionText = isCompleted ? 'Odebrat DokonÄenÃ­ (DokonÄeno)' : 'OznaÄit jako DokonÄenÃ©';
Â Â Â Â const completionIcon = isCompleted ? 'fas fa-undo' : 'fas fa-check-double';
Â Â Â Â Â 
Â Â Â Â return `
Â Â Â Â Â Â Â Â <div style="color: #0b1220; font-family: sans-serif; min-width: 180px;">
Â Â Â Â Â Â Â Â Â Â Â Â <h3 style="margin: 0 0 5px; color: ${accentColor};">${data.n}</h3>
Â Â Â Â Â Â Â Â Â Â Â Â <p style="margin: 0 0 5px; font-size: 11px;">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Okres: <strong>${data.o}</strong><br>
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â TravnatÃ¡ plocha: <strong>${data.grass_m2.toLocaleString('cs-CZ')} mÂ²</strong>
Â Â Â Â Â Â Â Â Â Â Â Â </p>
Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â <!-- TlaÄÃ­tko pro SledovÃ¡nÃ­ DokonÄenÃ­ -->
Â Â Â Â Â Â Â Â Â Â Â Â <button onclick="window.toggleCompletionStatus('${data.n}')"
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â style="background: ${isCompleted ? completionColor : '#020617'}; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â color: ${isCompleted ? 'white' : completionColor}; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â border: 1px solid ${completionColor}; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â padding: 6px 10px; border-radius: 6px; cursor: pointer; margin-top: 5px; width: 100%; font-weight: bold;">
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â <i class="${completionIcon}"></i> ${completionText}
Â Â Â Â Â Â Â Â Â Â Â Â </button>
Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â <hr style="border-color: #ccc; margin: 8px 0;">
Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â <!-- Odkaz na Google Maps -->
Â Â Â Â Â Â Â Â Â Â Â Â <a href="https://www.google.com/maps/search/?api=1&query=${data.lat},${data.lon}" target="_blank" style="display: block; text-align: center; color: ${accentColor}; margin-top: 5px;">OtevÅ™Ã­t v Google Maps</a>
Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â <!-- TlaÄÃ­tka pro Trasu -->
Â Â Â Â Â Â Â Â Â Â Â Â ${isInRoute 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â ? `<button onclick="window.toggleRoutePoint('${data.n}')" style="background: ${accentColor}; color: white; border: none; padding: 5px 10px; border-radius: 6px; cursor: pointer; margin-top: 5px; width: 100%; font-weight: bold;"><i class="fas fa-minus-circle"></i> Odebrat z Trasy</button>`
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â : `<button onclick="window.toggleRoutePoint('${data.n}')" style="background: #0f172a; color: white; border: 1px solid ${accentColor}; padding: 5px 10px; border-radius: 6px; cursor: pointer; margin-top: 5px; width: 100%;"><i class="fas fa-plus-circle"></i> PÅ™idat do Trasy</button>`
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â <button onclick="window.startRouteFromPoint('${data.n}')" style="background: none; color: ${accentColor}; border: 1px solid ${accentColor}; padding: 5px 10px; border-radius: 6px; cursor: pointer; margin-top: 8px; width: 100%;"><i class="fas fa-play"></i> Zvolit jako PoÄÃ¡teÄnÃ­ Bod</button>
Â Â Â Â Â Â Â Â </div>
Â Â Â Â `;
}
Â 
function render() {
Â Â Â Â markers.forEach(m => map.removeLayer(m));
Â Â Â Â markers = [];
Â Â Â Â Â 
Â Â Â Â const accentColor = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
Â Â Â Â const completedColor = getComputedStyle(document.documentElement).getPropertyValue('--completed');
Â 
Â Â Â Â filtered.forEach(d => {
Â Â Â Â Â Â Â Â const isCompleted = completionData[d.n] ? completionData[d.n].isCompleted : false;
Â Â Â Â Â Â Â Â const markerColor = isCompleted ? completedColor : accentColor;
Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â const m = L.circleMarker([d.lat, d.lon], {
Â Â Â Â Â Â Â Â Â Â Â Â radius: isCompleted ? 10 : 8,
Â Â Â Â Â Â Â Â Â Â Â Â color: isCompleted ? completedColor : accentColor,
Â Â Â Â Â Â Â Â Â Â Â Â fillColor: isCompleted ? completedColor : accentColor,
Â Â Â Â Â Â Â Â Â Â Â Â fillOpacity: isCompleted ? 0.9 : 0.8,
Â Â Â Â Â Â Â Â Â Â Â Â weight: 2
Â Â Â Â Â Â Â Â }).addTo(map);
Â 
Â Â Â Â Â Â Â Â m.data = d;
Â Â Â Â Â Â Â Â m.bindPopup(() => getPopupContent(d));
Â 
Â Â Â Â Â Â Â Â // NastavenÃ­ tÅ™Ã­dy pro outline
Â Â Â Â Â Â Â Â m.on('add', function() {
Â Â Â Â Â Â Â Â Â Â Â Â const markerElement = m.getElement();
Â Â Â Â Â Â Â Â Â Â Â Â if (markerElement) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (isCompleted) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â markerElement.classList.add('completed-area');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â markerElement.classList.remove('completed-area');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Aktualizace tÅ™Ã­dy pro zvÃ½raznÄ›nÃ­ trasy
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (route.includes(d)) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â markerElement.classList.add('route-active');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â markerElement.classList.remove('route-active');
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â });
Â 
Â Â Â Â Â Â Â Â const markerElement = m.getElement();
Â Â Â Â Â Â Â Â if (markerElement) {
Â Â Â Â Â Â Â Â Â Â Â Â // PÅ™i rychlÃ©m pÅ™epnutÃ­/renderu, kdy uÅ¾ je element v DOM
Â Â Â Â Â Â Â Â Â Â Â Â Â if (isCompleted) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â markerElement.classList.add('completed-area');
Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â markerElement.classList.remove('completed-area');
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â if (route.includes(d)) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â markerElement.classList.add('route-active');
Â Â Â Â Â Â Â Â Â Â Â Â } else {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â markerElement.classList.remove('route-active');
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â markers.push(m);
Â Â Â Â });
Â Â Â Â Â 
Â Â Â Â document.getElementById('stObj').textContent = filtered.length;
Â Â Â Â updateRoute();
}
Â 
window.toggleRoutePoint = function(name) {
Â Â Â Â const data = objects.find(o => o.n === name);
Â Â Â Â if (!data) return;
Â Â Â Â Â 
Â Â Â Â const index = route.indexOf(data);
Â 
Â Â Â Â if (index === -1) {
Â Â Â Â Â Â Â Â route.push(data);
Â Â Â Â } else {
Â Â Â Â Â Â Â Â route.splice(index, 1);
Â Â Â Â }
Â 
Â Â Â Â render();
}
Â 
window.startRouteFromPoint = function(name) {
Â Â Â Â const data = objects.find(o => o.n === name);
Â Â Â Â if (!data) return;
Â 
Â Â Â Â route = [data];
Â Â Â Â map.closePopup();
Â Â Â Â render();
}
Â 
function updateRoute() {
Â Â Â Â if (routingControl) {
Â Â Â Â Â Â Â Â map.removeControl(routingControl);
Â Â Â Â Â Â Â Â routingControl = null;
Â Â Â Â }
Â 
Â Â Â Â if (route.length < 2) {
Â Â Â Â Â Â Â Â document.getElementById('stKm').textContent = '0.0';
Â Â Â Â Â Â Â Â return;
Â Â Â Â }
Â 
Â Â Â Â const accentPrimary = getComputedStyle(document.documentElement).getPropertyValue('--accent-primary');
Â 
Â Â Â Â routingControl = L.Routing.control({
Â Â Â Â Â Â Â Â waypoints: route.map(p => L.latLng(p.lat, p.lon)),
Â Â Â Â Â Â Â Â routeWhileDragging: false,
Â Â Â Â Â Â Â Â show: false,
Â Â Â Â Â Â Â Â createMarker: () => null,
Â Â Â Â Â Â Â Â lineOptions: {
Â Â Â Â Â Â Â Â Â Â Â Â styles: [{color: accentPrimary, weight: 5, opacity: 0.8, dashArray: '10, 5'}]
Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â router: L.Routing.osrmv1({
Â Â Â Â Â Â Â Â Â Â Â Â serviceUrl: 'https://router.project-osrm.org/route/v1'
Â Â Â Â Â Â Â Â })
Â Â Â Â }).addTo(map);
Â 
Â Â Â Â routingControl.on('routesfound', function(e) {
Â Â Â Â Â Â Â Â const km = e.routes[0].summary.totalDistance / 1000;
Â Â Â Â Â Â Â Â document.getElementById('stKm').textContent = km.toFixed(1);
Â Â Â Â });
}
Â 
function clearRoute() {
Â Â Â Â route = [];
Â Â Â Â if (routingControl) {
Â Â Â Â Â Â Â Â map.removeControl(routingControl);
Â Â Â Â Â Â Â Â routingControl = null;
Â Â Â Â }
Â Â Â Â removeCurrentLocationMarker(); // OdstranÄ›nÃ­ markeru polohy
Â Â Â Â render();
}
Â 
function startRoute() {
Â Â Â Â clearRoute();
}
Â 
function applyFilters() {
Â Â Â Â const nameFilter = document.getElementById('fName').value.toLowerCase();
Â Â Â Â const okresFilter = document.getElementById('fOkres').value;
Â 
Â Â Â Â filtered = objects.filter(d => 
Â Â Â Â Â Â Â Â (!nameFilter || d.n.toLowerCase().includes(nameFilter)) &&
Â Â Â Â Â Â Â Â (okresFilter === 'all' || d.o === okresFilter)
Â Â Â Â );
Â Â Â Â render();
}
Â 
function togglePanel() {
Â Â Â Â document.getElementById('filterPanel').classList.toggle('open');
}
Â 
Â 
// --- GEMINI API LOGIKA ---
Â 
const API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent";
const apiKey = "YOUR_GEMINI_API_KEY_HERE";Â  // NahraÄte svÃ½m skuteÄnÃ½m API klÃ­Äem pro zprovoznÄ›nÃ­ AI
Â 
function showModal(title, content, sources = []) {
Â Â Â Â document.getElementById('aiModalTitle').textContent = title;
Â Â Â Â document.getElementById('aiModalBody').innerHTML = content;
Â Â Â Â Â 
Â Â Â Â const sourcesDiv = document.getElementById('aiModalSources');
Â Â Â Â if (sources.length > 0) {
Â Â Â Â Â Â Â Â sourcesDiv.style.display = 'block';
Â Â Â Â Â Â Â Â sourcesDiv.innerHTML = '<strong>Zdroje pro OvÄ›Å™enÃ­:</strong><br>' + sources.map(s => 
Â Â Â Â Â Â Â Â Â Â Â Â `<a href="${s.uri}" target="_blank" class="text-xs text-blue-400 hover:text-blue-200 block">${s.title}</a>`
Â Â Â Â Â Â Â Â ).join('');
Â Â Â Â } else {
Â Â Â Â Â Â Â Â sourcesDiv.style.display = 'none';
Â Â Â Â }
Â Â Â Â Â 
Â Â Â Â document.getElementById('aiModal').style.display = 'flex';
}
Â 
function closeModal() {
Â Â Â Â document.getElementById('aiModal').style.display = 'none';
}
Â 
async function fetchWithBackoff(url, options, maxRetries = 5) {
Â Â Â Â for (let attempt = 0; attempt < maxRetries; attempt++) {
Â Â Â Â Â Â Â Â try {
Â Â Â Â Â Â Â Â Â Â Â Â const response = await fetch(url, options);
Â Â Â Â Â Â Â Â Â Â Â Â if (!response.ok) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â if (response.status === 429 && attempt < maxRetries - 1) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â await new Promise(resolve => setTimeout(resolve, delay));
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â continue; 
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â throw new Error(`API call failed with status: ${response.status}`);
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â return response;
Â Â Â Â Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â Â Â Â Â if (attempt === maxRetries - 1) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â throw error;
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â const delay = Math.pow(2, attempt) * 1000 + Math.random() * 1000;
Â Â Â Â Â Â Â Â Â Â Â Â await new Promise(resolve => setTimeout(resolve, delay));
Â Â Â Â Â Â Â Â }
Â Â Â Â }
}
Â 
window.generateRoutePlan = async function() {
Â Â Â Â if (route.length < 2) {
Â Â Â Â Â Â Â Â showModal("Chyba PlÃ¡nu Trasy", `
Â Â Â Â Â Â Â Â Â Â Â Â <p>Pro generovÃ¡nÃ­ protokolu inspekce musÃ­ trasa obsahovat minimÃ¡lnÄ› dva objekty.<br>
Â Â Â Â Â Â Â Â Â Â Â Â AktuÃ¡lnÄ› mÃ¡te vybrÃ¡no: <strong>${route.length}</strong> objektÅ¯.</p>
Â Â Â Â Â Â Â Â `);
Â Â Â Â Â Â Â Â return;
Â Â Â Â }
Â 
Â Â Â Â showModal("GenerovÃ¡nÃ­ Protokolu Inspekce...", '<div class="spinner"></div>');
Â 
Â Â Â Â try {
Â Â Â Â Â Â Â Â const km = parseFloat(document.getElementById('stKm').textContent);
Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â const routeList = route.map((d, i) => 
Â Â Â Â Â Â Â Â Â Â Â Â `${i + 1}. ${d.n} (${d.o}) - Typ: ${d.n.includes('VDJ') ? 'Vodojem (VDJ)' : d.n.includes('ÃšV') ? 'Ãšpravna Vody (ÃšV)' : d.n.includes('ÄŒS') ? 'ÄŒerpacÃ­ Stanice (ÄŒS)' : 'OstatnÃ­'}`
Â Â Â Â Â Â Â Â ).join('\n');
Â 
Â Â Â Â Â Â Â Â const systemPrompt = `Jsi profesionÃ¡lnÃ­ plÃ¡novaÄ ÃºdrÅ¾by a terÃ©nnÃ­ch inspekcÃ­ vodohospodÃ¡Å™skÃ½ch zaÅ™Ã­zenÃ­ v ÄŒeskÃ© republice. TvÃ½m Ãºkolem je na zÃ¡kladÄ› seznamu navÅ¡tÃ­venÃ½ch bodÅ¯ a celkovÃ© vzdÃ¡lenosti vytvoÅ™it struÄnÃ½, formÃ¡tovanÃ½ a akÄnÃ­ plÃ¡n inspekÄnÃ­ho protokolu pro technika. Protokol by mÄ›l obsahovat tyto sekce:
1. **PÅ™ehled Trasy:** CelkovÃ¡ vzdÃ¡lenost, poÄet bodÅ¯ a celkovÃ½ odhadovanÃ½ Äas trvÃ¡nÃ­ inspekce (ÄistÃ½ Äas prÃ¡ce na mÃ­stÄ› bez cesty). PÅ™edpoklÃ¡dej 45-60 minut na ÃšV, 30-45 minut na VDJ, a 20-30 minut na ÄŒS.
2. **KlÃ­ÄovÃ© Priority:** Navrhni, kterÃ© zaÅ™Ã­zenÃ­ vyÅ¾adujÃ­ detailnÄ›jÅ¡Ã­ kontrolu a proÄ (napÅ™. ÃšV jako kritickÃ© body).
3. **KontrolnÃ­ Ãškony:** VytvoÅ™ krÃ¡tkÃ½ kontrolnÃ­ seznam pro kaÅ¾dÃ½ typ zaÅ™Ã­zenÃ­ (VDJ, ÃšV, ÄŒS) - maximÃ¡lnÄ› 3 nejdÅ¯leÅ¾itÄ›jÅ¡Ã­ Ãºkony pro kaÅ¾dÃ½ typ (napÅ™. kontrola oplocenÃ­, mÄ›Å™enÃ­ prÅ¯toku, vizuÃ¡lnÃ­ kontrola armatur, apod.).
4. **DoporuÄenÃ­ pro Optimalizaci:** StruÄnÃ© doporuÄenÃ­ k pÅ™Ã­padnÃ© optimalizaci trasy nebo zdrojÅ¯.
OdpovÃ­dej pouze v ÄeÅ¡tinÄ›. PouÅ¾ij Markdown pro formÃ¡tovÃ¡nÃ­, jako jsou seznamy a tuÄnÃ© pÃ­smo.`;
Â 
Â Â Â Â Â Â Â Â const userQuery = `NaplÃ¡novanÃ¡ trasa zahrnuje ${route.length} objektÅ¯ s celkovou vzdÃ¡lenostÃ­ ${km.toFixed(1)} km. Body trasy v poÅ™adÃ­:
Â 
${routeList}
Â 
Vygeneruj inspekÄnÃ­ protokol podle danÃ½ch pokynÅ¯.`;
Â 
Â 
Â Â Â Â Â Â Â Â const payload = {
Â Â Â Â Â Â Â Â Â Â Â Â contents: [{ parts: [{ text: userQuery }] }],
Â Â Â Â Â Â Â Â Â Â Â Â tools: [{ "google_search": {} }],
Â Â Â Â Â Â Â Â Â Â Â Â systemInstruction: {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â parts: [{ text: systemPrompt }]
Â Â Â Â Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â };
Â 
Â Â Â Â Â Â Â Â const response = await fetchWithBackoff(`${API_URL}?key=${apiKey}`, {
Â Â Â Â Â Â Â Â Â Â Â Â method: 'POST',
Â Â Â Â Â Â Â Â Â Â Â Â headers: { 'Content-Type': 'application/json' },
Â Â Â Â Â Â Â Â Â Â Â Â body: JSON.stringify(payload)
Â Â Â Â Â Â Â Â });
Â 
Â Â Â Â Â Â Â Â const result = await response.json();
Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â const candidate = result.candidates?.[0];
Â Â Â Â Â Â Â Â let generatedText = "Chyba: NepodaÅ™ilo se vygenerovat text. Zkuste to prosÃ­m znovu.";
Â Â Â Â Â Â Â Â let sources = [];
Â 
Â Â Â Â Â Â Â Â if (candidate && candidate.content?.parts?.[0]?.text) {
Â Â Â Â Â Â Â Â Â Â Â Â generatedText = candidate.content.parts[0].text;
Â 
Â Â Â Â Â Â Â Â Â Â Â Â const groundingMetadata = candidate.groundingMetadata;
Â Â Â Â Â Â Â Â Â Â Â Â if (groundingMetadata && groundingMetadata.groundingAttributions) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â sources = groundingMetadata.groundingAttributions
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .map(attribution => ({
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â uri: attribution.web?.uri,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â title: attribution.web?.title,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }))
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â .filter(source => source.uri && source.title);
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â showModal("âœ¨ Protokol Inspekce - GenerovÃ¡no AI", generatedText, sources);
Â 
Â Â Â Â } catch (error) {
Â Â Â Â Â Â Â Â showModal("Chyba API", `
Â Â Â Â Â Â Â Â Â Â Â Â <p>Nastala chyba pÅ™i komunikaci s AI sluÅ¾bou. Zkuste to prosÃ­m znovu.<br>
Â Â Â Â Â Â Â Â Â Â Â Â Detail chyby: ${error.message || 'NeznÃ¡mÃ¡ chyba'}</p>
Â Â Â Â Â Â Â Â `);
Â Â Â Â }
}
Â 
Â 
// --- LEAFLET.DRAW INTEGRACE ---
function initializeDrawControls() {
Â Â Â Â drawnItems = new L.FeatureGroup();
Â Â Â Â map.addLayer(drawnItems);
Â 
Â Â Â Â const drawControl = new L.Control.Draw({
Â Â Â Â Â Â Â Â edit: {
Â Â Â Â Â Â Â Â Â Â Â Â featureGroup: drawnItems,
Â Â Â Â Â Â Â Â Â Â Â Â poly: { allowIntersection: false }
Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â draw: {
Â Â Â Â Â Â Â Â Â Â Â Â polyline: {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â metric: true,
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â shapeOptions: {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â color: getComputedStyle(document.documentElement).getPropertyValue('--accent-secondary'),
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â weight: 3
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â Â Â Â Â },
Â Â Â Â Â Â Â Â Â Â Â Â polygon: { showArea: true, allowIntersection: false },
Â Â Â Â Â Â Â Â Â Â Â Â rectangle: { showArea: true },
Â Â Â Â Â Â Â Â Â Â Â Â circle: true,
Â Â Â Â Â Â Â Â Â Â Â Â marker: true,
Â Â Â Â Â Â Â Â Â Â Â Â circlemarker: false
Â Â Â Â Â Â Â Â }
Â Â Â Â });
Â 
Â Â Â Â drawControl.addTo(map);
Â Â Â Â const drawToolbarContainer = document.querySelector('.leaflet-draw');
Â Â Â Â if (drawToolbarContainer) {
Â Â Â Â Â Â Â Â drawToolbarContainer.style.display = 'none';
Â Â Â Â }
Â 
Â Â Â Â document.getElementById('draw-tool-btn').addEventListener('click', () => {
Â Â Â Â Â Â Â Â const drawToolbar = document.querySelector('.leaflet-draw-toolbar');
Â Â Â Â Â Â Â Â if (drawToolbar) {
Â Â Â Â Â Â Â Â Â Â Â Â const isVisible = drawToolbarContainer.style.display !== 'none';
Â Â Â Â Â Â Â Â Â Â Â Â drawToolbarContainer.style.display = isVisible ? 'none' : 'block';
Â Â Â Â Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â Â Â Â Â if (!isVisible) {
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â const buttonRect = document.getElementById('draw-tool-btn').getBoundingClientRect();
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawToolbarContainer.style.position = 'fixed';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawToolbarContainer.style.top = `${buttonRect.top + buttonRect.height + 5}px`;
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawToolbarContainer.style.left = '10px';
Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â drawToolbarContainer.style.zIndex = '1000';
Â Â Â Â Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â }
Â Â Â Â });
Â 
Â Â Â Â map.on(L.Draw.Event.CREATED, function (e) {
Â Â Â Â Â Â Â Â const type = e.layerType;
Â Â Â Â Â Â Â Â const layer = e.layer;
Â Â Â Â Â Â Â Â Â 
Â Â Â Â Â Â Â Â if (type === 'polyline') {
Â Â Â Â Â Â Â Â Â Â Â Â const distance = L.GeometryUtil.length(layer);
Â Â Â Â Â Â Â Â Â Â Â Â layer.bindPopup(`<strong>VzdÃ¡lenost:</strong> ${(distance / 1000).toFixed(2)} km`).openPopup();
Â Â Â Â Â Â Â Â }
Â Â Â Â Â Â Â Â if (type === 'polygon' || type === 'rectangle') {
Â Â Â Â Â Â Â Â Â Â Â Â Â const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
Â Â Â Â Â Â Â Â Â Â Â Â layer.bindPopup(`<strong>Plocha:</strong> ${area.toFixed(2)} mÂ²`).openPopup();
Â Â Â Â Â Â Â Â }
Â 
Â Â Â Â Â Â Â Â drawnItems.addLayer(layer);
Â Â Â Â });
}
Â 
// --- INICIALIZACE ---
Â 
[...new Set(objects.map(o => o.o))].forEach(o => {
Â Â Â Â document.getElementById('fOkres').innerHTML += `<option value="${o}">${o}</option>`;
});
Â 
document.addEventListener('DOMContentLoaded', () => {
Â Â Â Â initializeFirebase(); // Inicializace DB
Â Â Â Â // render() je volÃ¡no po inicializaci databÃ¡ze v listenForCompletionUpdates
Â Â Â Â initializeDrawControls();
Â Â Â Â const bounds = L.latLngBounds(objects.map(o => [o.lat, o.lon]));
Â Â Â Â map.fitBounds(bounds);
Â Â Â Â render();
});
Â 
window.closeModal = closeModal;
Â 
</script>
Â 
</body></html>